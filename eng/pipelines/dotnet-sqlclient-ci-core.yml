#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
  # True to emit debug information and steps.
  - name: debug
    type: boolean
    default: false

  # The target frameworks to build and run tests for on Windows.
  #
  # These are _not_ the target frameworks to build the driver packages for.
  #
  - name: targetFrameworks
    type: object
    default: [net462, net8.0, net9.0, net10.0]

  # The target frameworks to build and run tests for on Unix.
  #
  # These are _not_ the target frameworks to build the driver packages for.
  #
  - name: targetFrameworksUnix
    type: object
    default: [net8.0, net9.0, net10.0]

  # Netcore Version for Test Utilities
  - name: netcoreVersionTestUtils
    type: object
    default: net10.0

  # Build Platforms on Windows
  - name: buildPlatforms
    type: object
    default: [AnyCPU]

  # Test sets to run
  - name: testSets
    type: object
    default: [1, 2, 3]

  #  Use Managed/Native SNI on Windows; valid values are:
  #    [true, false]
  #    [false, true]
  #    [false]
  #    [true]
  - name: useManagedSNI
    type: object
    default: [false, true]

  # SNI Version Override
  - name: SNIVersion
    type: string
    default: ""

  # SNI Version Override Nuget Feed
  - name: SNIValidationFeed
    type: string
    default: https://sqlclientdrivers.pkgs.visualstudio.com/ADO.Net/_packaging/SNIValidation/nuget/v3/index.json

  # The C# project reference type to use when building and packing the packages.
  - name: referenceType
    type: string
    values:
      # Reference sibling packages as NuGet packages.
      - Package
      # Reference sibling packages as C# projects.
      - Project

  - name: buildConfiguration
    type: string
    values:
      - Debug
      - Release

  - name: defaultPoolName
    type: string
    default: $(ci_var_defaultPoolName)

  # True to add a Stress Test stage to the pipeline.
  - name: enableStressTests
    type: boolean
    default: false

  # The timeout, in minutes, for each test job.
  - name: testJobTimeout
    type: number

  # If true, the Always Encrypted (AE) test set will be run, which requires
  # Enclave-enabled SQL Server instances.
  - name: runAlwaysEncryptedTests
    type: boolean
    default: true

  - name: dotnetVerbosity
    type: string
    default: normal
    values:
      - quiet
      - minimal
      - normal
      - detailed
      - diagnostic

variables:
  - template: /eng/pipelines/libraries/ci-build-variables.yml@self

  - name: abstractionsArtifactsName
    value: Abstractions.Artifacts

  - name: azureArtifactsName
    value: Azure.Artifacts

  - name: loggingArtifactsName
    value: Logging.Artifacts

  - name: mdsArtifactsName
    value: MDS.Artifacts

stages:
  # Generate secrets used throughout the pipeline.
  - template: /eng/pipelines/stages/generate-secrets-ci-stage.yml@self
    parameters:
      debug: ${{ parameters.debug }}

  # Build the Abstractions package, and publish it to the pipeline artifacts
  # under the given artifact name.
  #
  # When building via packages, this depends on the Logging stage since
  # Abstractions has a package dependency on Logging.
  - template: /eng/pipelines/stages/build-abstractions-package-ci-stage.yml@self
    parameters:
      abstractionsArtifactsName: $(abstractionsArtifactsName)
      abstractionsAssemblyFileVersion: $(abstractionsAssemblyFileVersion)
      abstractionsPackageVersion: $(abstractionsPackageVersion)
      buildConfiguration: ${{ parameters.buildConfiguration }}
      debug: ${{ parameters.debug }}
      dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
      # When building Abstractions via packages, we must depend on the Logging
      # package.
      ${{ if eq(parameters.referenceType, 'Package') }}:
        additionalDependsOn:
          - build_logging_package_stage

  # Build the Logging package, and publish it to the pipeline artifacts
  # under the given artifact name.  This runs in parallel with the Secrets
  # generation stage since it has no package dependencies.
  - template: /eng/pipelines/stages/build-logging-package-ci-stage.yml@self
    parameters:
      loggingArtifactsName: $(loggingArtifactsName)
      loggingAssemblyFileVersion: $(loggingAssemblyFileVersion)
      loggingPackageVersion: $(loggingPackageVersion)
      buildConfiguration: ${{ parameters.buildConfiguration }}
      debug: ${{ parameters.debug }}
      dotnetVerbosity: ${{ parameters.dotnetVerbosity }}

  # Build the SqlClienet package.
  #
  # For legacy reasons, this also builds the AKV package.
  #
  - template: /eng/pipelines/stages/build-sqlclient-package-ci-stage.yml@self
    parameters:
      abstractionsArtifactsName: $(abstractionsArtifactsName)
      abstractionsPackageVersion: $(abstractionsPackageVersion)
      buildConfiguration: ${{ parameters.buildConfiguration }}
      loggingArtifactsName: $(loggingArtifactsName)
      loggingPackageVersion: $(loggingPackageVersion)
      mdsArtifactsName: $(mdsArtifactsName)
      mdsPackageVersion: $(mdsPackageVersion)
      referenceType: ${{ parameters.referenceType }}
      SNIVersion: ${{ parameters.SNIVersion }}
      SNIValidationFeed: ${{ parameters.SNIValidationFeed }}
      # When building SqlClient via packages, we must depend on the Abstractions and Logging
      # packages.
      ${{ if eq(parameters.referenceType, 'Package') }}:
        additionalDependsOn:
          - build_abstractions_package_stage
          - build_logging_package_stage

  # Build the Azure package, and publish it to the pipeline artifacts under the
  # given artifact name.
  - template: /eng/pipelines/stages/build-azure-package-ci-stage.yml@self
    parameters:
      abstractionsArtifactsName: $(abstractionsArtifactsName)
      abstractionsPackageVersion: $(abstractionsPackageVersion)
      azureArtifactsName: $(azureArtifactsName)
      azureAssemblyFileVersion: $(azureAssemblyFileVersion)
      azurePackageVersion: $(azurePackageVersion)
      buildConfiguration: ${{ parameters.buildConfiguration }}
      debug: ${{ parameters.debug }}
      # When building via packages, we must depend on the Abstractions, Logging,
      # and MDS packages.
      ${{ if eq(parameters.referenceType, 'Package') }}:
        additionalDependsOn:
          - build_abstractions_package_stage
          - build_logging_package_stage
          - build_sqlclient_package_stage
      dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
      mdsArtifactsName: $(mdsArtifactsName)
      mdsPackageVersion: $(mdsPackageVersion)
      referenceType: ${{ parameters.referenceType }}

  # Run the stress tests, if desired.
  - ${{ if eq(parameters.enableStressTests, true) }}:
      - template: /eng/pipelines/stages/stress-tests-ci-stage.yml@self
        parameters:
          buildConfiguration: ${{ parameters.buildConfiguration }}
          additionalDependsOn:
            - build_sqlclient_package_stage
            - build_azure_package_stage
          mdsArtifactsName: $(mdsArtifactsName)
          mdsPackageVersion: $(mdsPackageVersion)
          azurePackageVersion: $(azurePackageVersion)
          dotnetVerbosity: ${{ parameters.dotnetVerbosity }}

  # Run the MDS and AKV tests.
  - template: /eng/pipelines/common/templates/stages/ci-run-tests-stage.yml@self
    parameters:
      debug: ${{ parameters.debug }}
      buildConfiguration: ${{ parameters.buildConfiguration }}
      referenceType: ${{ parameters.referenceType }}
      abstractionsArtifactsName: $(abstractionsArtifactsName)
      abstractionsPackageVersion: $(abstractionsPackageVersion)
      loggingArtifactsName: $(loggingArtifactsName)
      loggingPackageVersion: $(loggingPackageVersion)
      mdsArtifactsName: $(mdsArtifactsName)
      mdsPackageVersion: $(mdsPackageVersion)
      testJobTimeout: ${{ parameters.testJobTimeout }}

      # When testing MDS via packages, we must depend on the Abstractions,
      # Logging, MDS, and Azure packages.
      ${{ if eq(parameters.referenceType, 'Package') }}:
        additionalDependsOn:
          - build_abstractions_package_stage
          - build_logging_package_stage
          - build_sqlclient_package_stage
          - build_azure_package_stage

      # Steps to run prior to building and running tests on each job.
      prebuildSteps:
        - ${{if ne(parameters.SNIVersion, '')}}:
            - template: /eng/pipelines/common/templates/steps/override-sni-version.yml@self
              parameters:
                SNIVersion: ${{parameters.SNIVersion}}
                SNIValidationFeed: ${{parameters.SNIValidationFeed}}

        - ${{if eq(parameters.debug, true)}}:
            - pwsh: "Get-ChildItem env: | Sort-Object Name"
              displayName: "[Debug] List Environment Variables"

      # Include the code coverage job if the build type is Project.
      ${{ if eq(parameters.referenceType, 'Project') }}:
        # Jobs to run as part of the tests stage, after the tests are done.
        postTestJobs:
          - template: /eng/pipelines/common/templates/jobs/ci-code-coverage-job.yml@self
            parameters:
              debug: ${{ parameters.debug }}
              # We only want to upload coverage results to CodeCov from certain
              # pipelines.  We use the pipeline name (Build.DefinitionName) to
              # choose.  This is a predefined variable that is available at
              # template expansion time, so we can use it to supply a true boolean
              # value to the upload parameter.
              #
              # https://learn.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml#build-variables-devops-services
              #
              # We're choosing to upload from these pipelines only:
              #
              # - PR-SqlClient-Project
              # - CI-SqlClient
              #
              # Other pipelines that share this template don't add much, if any,
              # value to the coverage reports.  They have not been configured with
              # suitable CodeCov credentials to perform the upload.
              #
              upload: ${{ or(eq(variables['Build.DefinitionName'], 'PR-SqlClient-Project'), eq(variables['Build.DefinitionName'], 'CI-SqlClient')) }}

      # Configuration of test jobs.  Each entry in this object will become a test job, and the
      # properties of each entry will be supplied as parameters to the test job template.
      testConfigurations:
        # Windows Server 22 with local SQL Server 2019, x64 build platform.
        windows_sql_19_x64:
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Sql19: ADO-MMS22-SQL19
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          configSqlFor: local
          operatingSystem: Windows
          # config.json properties
          configProperties:
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: true
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            FileStreamDirectory: $(FileStreamDirectory)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)
            SQLRootPath: $(SQL19RootPath)
            enableLocalDB: true

        # Windows Server 22 with local SQL Server 2019, x86 build platform.
        windows_sql_19_x86:
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Sql19_x86: ADO-MMS22-SQL19
          TargetFrameworks: [net462, net8.0, net9.0]
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: [false]
          configSqlFor: local
          operatingSystem: Windows
          configProperties:
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: true
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            FileStreamDirectory: $(FileStreamDirectory)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)
            x86TestTargetFrameworks: [net462, net8.0, net9.0]
            SQLRootPath: $(SQL19RootPath)
            enableLocalDB: true

        # Windows Server 22 with local SQL Server 2022, x64 build platform.
        windows_sql_22_x64:
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Sql22: ADO-MMS22-SQL22
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          configSqlFor: local
          operatingSystem: Windows
          configProperties:
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: true
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            FileStreamDirectory: $(FileStreamDirectory)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)
            SQLRootPath: $(SQL22RootPath)
            enableLocalDB: true

        # Windows Server 22 with local SQL Server 2022, x86 build platform.
        windows_sql_22_x86:
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Sql22_x86: ADO-MMS22-SQL22
          TargetFrameworks: [net462, net8.0, net9.0]
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: [false]
          configSqlFor: local
          operatingSystem: Windows
          configProperties:
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: true
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            FileStreamDirectory: $(FileStreamDirectory)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)
            x86TestTargetFrameworks: [net462, net8.0, net9.0]
            SQLRootPath: $(SQL22RootPath)
            enableLocalDB: true

        # Windows Server 22 with local SQL Server 2022 Named Instance, x64 build platform.
        windows_sql_22_named_instance:
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Sql22_Named_Instance: ADO-MMS22-SQL22-WITH-NAMED-INSTANCE
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          configSqlFor: local
          operatingSystem: Windows
          configProperties:
            TCPConnectionString: $(SQL_TCP_INSTANCE_CONN_STRING)
            NPConnectionString: $(SQL_NP_INSTANCE_CONN_STRING)
            SupportsIntegratedSecurity: true
            SQLRootPath: $(SQL22RootPath)
            instanceName: $(NamedInstance)

        # Windows Server 2022 and Windows 11, x64 build platform, with Azure SQL Server.
        windows_azure_sql:
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Azure_Sql: ADO-MMS22-SQL19
            Win11_Azure_Sql: ADO-CI-Win11
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          configSqlFor: azure
          operatingSystem: Windows
          configProperties:
            TCPConnectionString: $(AZURE_DB_TCP_CONN_STRING)
            NPConnectionString: $(AZURE_DB_NP_CONN_STRING)
            AADAuthorityURL: $(AADAuthorityURL)
            # Pipeline runs against forks of the repo don't have access to Library secrets, so we
            # omit them entirely from the configProperties, which causes the dependent tests to be
            # skipped.
            ${{ if eq(variables['System.PullRequest.IsFork'], 'False') }}:
              AADPasswordConnectionString: $(AAD_PASSWORD_CONN_STR)
              AADServicePrincipalSecret: $(AADServicePrincipalSecret)
            AADServicePrincipalId: $(AADServicePrincipalId)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: false
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

        # Windows 11 on ARM64 with Azure SQL Server.
        windows_azure_arm64_sql:
          pool: ADO-CI-PUBLIC-ARM64-1ES-EUS-POOL
          images:
            Win11_ARM64_Azure_Sql: ADO-WIN11-ARM64
          isArm64: true
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          configSqlFor: azure
          operatingSystem: Windows
          configProperties:
            TCPConnectionString: $(AZURE_DB_TCP_CONN_STRING_eastus)
            NPConnectionString: $(AZURE_DB_NP_CONN_STRING_eastus)
            AADAuthorityURL: $(AADAuthorityURL)
            ${{ if eq(variables['System.PullRequest.IsFork'], 'False') }}:
              AADPasswordConnectionString: $(AAD_PASSWORD_CONN_STR_eastus)
              AADServicePrincipalSecret: $(AADServicePrincipalSecret)
            AADServicePrincipalId: $(AADServicePrincipalId)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: false
            UserManagedIdentityClientId: $(UserManagedIdentityClientId_eastus)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

        # Linux Ubuntu 20 and 22 with local SQL Server 2022, x64 build platform.
        linux_ub20_22_sql_22:
          pool: ${{parameters.defaultPoolName }}
          images:
            Ubuntu20_Sql22: ADO-UB20-SQL22
            Ubuntu22_Sql22: ADO-UB22-SQL22
          TargetFrameworks: ${{parameters.targetFrameworksUnix }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: [AnyCPU]
          testSets: ${{parameters.testSets }}
          useManagedSNI: [true]
          configSqlFor: local
          operatingSystem: Linux
          configProperties:
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: false
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)

        # Linux Ubuntu 22 with Azure SQL Server, x64 build platform.
        linux_azure_sql:
          pool: ${{parameters.defaultPoolName }}
          images:
            Ubuntu22_Azure_Sql: ADO-UB22-SQL22
          TargetFrameworks: ${{parameters.targetFrameworksUnix }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: [AnyCPU]
          testSets: ${{parameters.testSets }}
          useManagedSNI: [true]
          configSqlFor: azure
          operatingSystem: Linux
          configProperties:
            TCPConnectionString: $(AZURE_DB_TCP_CONN_STRING)
            NPConnectionString: $(AZURE_DB_NP_CONN_STRING)
            AADAuthorityURL: $(AADAuthorityURL)
            ${{ if eq(variables['System.PullRequest.IsFork'], 'False') }}:
              AADPasswordConnectionString: $(AAD_PASSWORD_CONN_STR)
              AADServicePrincipalSecret: $(AADServicePrincipalSecret)
            AADServicePrincipalId: $(AADServicePrincipalId)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: false
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

        # macOS with local SQL Server 2022, x64 build platform.
        mac_sql_22:
          pool: Azure Pipelines
          hostedPool: true
          images:
            MacOSLatest_Sql22: macos-latest
          TargetFrameworks: ${{parameters.targetFrameworksUnix }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: [AnyCPU]
          testSets: ${{parameters.testSets }}
          useManagedSNI: [true]
          configSqlFor: local
          operatingSystem: Mac
          configProperties:
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            SupportsIntegratedSecurity: false
            ManagedIdentitySupported: false
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

        # Enclave tests
        #
        # Only run these tests if explicitly enabled, and if we're not a forked repo (which won't
        # have access to the necessary Library secrets).
        ${{ if and(eq(parameters.runAlwaysEncryptedTests, true), eq(variables['System.PullRequest.IsFork'], 'False')) }}:
          # Windows Server 22 with remote Enclave-enabled SQL Server 2019, x64 build platform.
          windows_enclave_sql:
            pool: ADO-CI-AE-1ES-Pool
            images:
              Win22_Enclave_Sql19: ADO-MMS22-SQL19
            TargetFrameworks: ${{parameters.targetFrameworks }}
            netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
            buildPlatforms: ${{parameters.buildPlatforms }}
            testSets: [AE]
            useManagedSNI: ${{parameters.useManagedSNI }}
            configSqlFor: enclave
            operatingSystem: Windows
            configProperties:
              TCPConnectionStringHGSVBS: $(SQL_TCP_CONN_STRING_HGSVBS)
              TCPConnectionStringNoneVBS: $(SQL_TCP_CONN_STRING_NoneVBS)
              TCPConnectionStringAASSGX: $(SQL_TCP_CONN_STRING_AASSGX)
              EnclaveEnabled: true
              AADAuthorityURL: $(AADAuthorityURL)
              AADServicePrincipalId: $(AADServicePrincipalId)
              AADServicePrincipalSecret: $(AADServicePrincipalSecret)
              AzureKeyVaultUrl: $(AzureKeyVaultUrl)
              AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
              SupportsIntegratedSecurity: true
              UserManagedIdentityClientId: $(UserManagedIdentityClientId)
              AliasName: $(SQLAliasName)
              LocalDbAppName: $(LocalDbAppName)
              LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

          # Linux Ubuntu 22 with remote Enclave-enabled SQL Server 2019, x64 build platform.
          linux_enclave_sql:
            pool: ADO-CI-AE-1ES-Pool
            images:
              Ubuntu20_Enclave_Sql19: ADO-UB22-Sql22
            TargetFrameworks: ${{parameters.targetFrameworksUnix }}
            netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
            buildPlatforms: [AnyCPU]
            testSets: [AE]
            useManagedSNI: [true]
            configSqlFor: enclave
            operatingSystem: Linux
            configProperties:
              TCPConnectionStringHGSVBS: $(SQL_TCP_CONN_STRING_HGSVBS)
              TCPConnectionStringNoneVBS: $(SQL_TCP_CONN_STRING_NoneVBS)
              TCPConnectionStringAASSGX: $(SQL_TCP_CONN_STRING_AASSGX)
              EnclaveEnabled: true
              AADServicePrincipalId: $(AADServicePrincipalId)
              AADServicePrincipalSecret: $(AADServicePrincipalSecret)
              AzureKeyVaultUrl: $(AzureKeyVaultUrl)
              AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
              SupportsIntegratedSecurity: false
              UserManagedIdentityClientId: $(UserManagedIdentityClientId)
              LocalDbAppName: $(LocalDbAppName)
              LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
