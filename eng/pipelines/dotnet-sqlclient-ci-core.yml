#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
- name: 'debug'
  displayName: 'Enable debug output'
  type: boolean
  default: false

# The target frameworks to build and run tests for on Windows.
#
# These are _not_ the target frameworks to build the driver packages for.
#
- name: targetFrameworks
  displayName: 'Target Frameworks on Windows'
  type: object
  default: [net462, net8.0, net9.0, net10.0]

# The target frameworks to build and run tests for on Unix.
#
# These are _not_ the target frameworks to build the driver packages for.
#
- name: targetFrameworksUnix
  displayName: 'Target Frameworks on Unix'
  type: object
  default: [net8.0, net9.0, net10.0]

- name: netcoreVersionTestUtils
  displayName: 'Netcore Version for Test Utilities'
  type: object
  default: net10.0

- name: buildPlatforms
  displayName: 'Build Platforms on Windows'
  type: object
  default: [AnyCPU]

- name: testSets
  displayName: 'Test Sets'
  type: object
  default: [1, 2, 3]

- name: useManagedSNI
  displayName: |
    Use Managed/Native SNI on Windows,
    values [false, true], [false] or [true] are allowed
  type: object
  default: [false, true]

- name: SNIVersion
  displayName: |
    SNI Version Override
  type: string
  default: ''

- name: SNIValidationFeed
  displayName: |
    SNI Version Override Nuget Feed
  type: string
  default: https://sqlclientdrivers.pkgs.visualstudio.com/ADO.Net/_packaging/SNIValidation/nuget/v3/index.json

# Frameworks to expect code coverage information for, and to compile into
# reports.
- name: codeCovTargetFrameworks
  displayName: 'Code Coverage Target Frameworks'
  type: object
  default: [net462, net8.0, net9.0, net10.0]

# The way we will reference sibling projects in the .csproj files:
#   Project - use <ProjectReference> references.
#   Package - use <PackageReference> references to NuGet packages in the
#             packages/ directory.
- name: referenceType
  displayName: 'Reference Type'
  values:
    - Project
    - Package

- name: buildConfiguration
  type: string
  values:
    - Debug
    - Release

- name: defaultPoolName
  type: string
  default: $(ci_var_defaultPoolName)

- name: enableStressTests
  displayName: Enable Stress Tests
  type: boolean
  default: false

# The timeout, in minutes, for each test job.
- name: testJobTimeout
  type: number

# If true, the Always Encrypted (AE) test set will be run, which requires
# Enclave-enabled SQL Server instances.
- name: runAlwaysEncryptedTests
  type: boolean
  default: true

- name: dotnetVerbosity
  displayName: dotnet CLI Verbosity
  type: string
  default: normal
  values:
    - quiet
    - minimal
    - normal
    - detailed
    - diagnostic

variables:
  - template: /eng/pipelines/libraries/ci-build-variables.yml@self
  
  - name: abstractionsArtifactName
    value: Abstractions.Artifact
  
  - name: azureArtifactName
    value: Azure.Artifact

  - name: mdsArtifactName
    value: MDS.Artifact

stages:

  # Build the Abstractions package, and publish it to the pipeline artifacts
  # under the given artifact name.
  - template: /eng/pipelines/stages/build-abstractions-package-ci-stage.yml@self
    parameters:
      abstractionsArtifactName: $(abstractionsArtifactName)
      abstractionsPackageVersion: $(abstractionsPackageVersion)
      buildConfiguration: ${{ parameters.buildConfiguration }}
      debug: ${{ parameters.debug }}
      dotnetVerbosity: ${{ parameters.dotnetVerbosity }}

  # Build MDS and its NuGet packages.
  - stage: build_mds_akv_packages_stage
    displayName: 'Build MDS & AKV Packages'

    # When building MDS via packages, we must depend on the Abstractions 
    # package.
    ${{ if eq(parameters.referenceType, 'Package') }}:
      dependsOn:
        - build_abstractions_package_stage
    ${{ else }}:
      dependsOn: []

    jobs:
    - template: /eng/pipelines/common/templates/jobs/ci-build-nugets-job.yml@self
      parameters:
        buildConfiguration: ${{ parameters.buildConfiguration }}
        referenceType: ${{ parameters.referenceType }}
        abstractionsPackageVersion: $(abstractionsPackageVersion)
        abstractionsArtifactName: $(abstractionsArtifactName)
        mdsPackageVersion: $(mdsPackageVersion)
        mdsArtifactName: $(mdsArtifactName)
        ${{if ne(parameters.SNIVersion, '')}}:
          prebuildSteps:
            - template: /eng/pipelines/common/templates/steps/override-sni-version.yml@self
              parameters:
                SNIVersion: ${{parameters.SNIVersion}}
                SNIValidationFeed: ${{parameters.SNIValidationFeed}}

  # Build the Azure package, and publish it to the pipeline artifacts under the
  # given artifact name.
  - template: /eng/pipelines/stages/build-azure-package-ci-stage.yml@self
    parameters:
      abstractionsArtifactName: $(abstractionsArtifactName)
      abstractionsPackageVersion: $(abstractionsPackageVersion)
      azureArtifactName: $(azureArtifactName)
      azurePackageVersion: $(azurePackageVersion)
      buildConfiguration: ${{ parameters.buildConfiguration }}
      debug: ${{ parameters.debug }}
      mdsArtifactName: $(mdsArtifactName)
      mdsPackageVersion: $(mdsPackageVersion)
      # When building via package references, we must depend on the Abstractions
      # and MDS packages
      ${{ if eq(parameters.referenceType, 'Package') }}:
        dependsOn:
          - build_abstractions_package_stage
          - build_mds_akv_packages_stage
      referenceType: ${{ parameters.referenceType }}
      ${{if eq(parameters.debug, 'true')}}:
        verbosity: diagnostic

  # Run the stress tests, if desired.
  - ${{ if eq(parameters.enableStressTests, true) }}:
    - template: /eng/pipelines/stages/stress-tests-ci-stage.yml@self
      parameters:
        buildConfiguration: ${{ parameters.buildConfiguration }}
        dependsOn:
          - build_mds_akv_packages_stage
          - build_azure_package_stage
        pipelineArtifactName: $(artifactName)
        mdsPackageVersion: $(mdsPackageVersion)
        dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
  
  # Run the MDS and AKV tests.
  - template: /eng/pipelines/common/templates/stages/ci-run-tests-stage.yml@self
    parameters:
      debug: ${{ parameters.debug }}
      buildConfiguration: ${{ parameters.buildConfiguration }}
      referenceType: ${{ parameters.referenceType }}
      abstractionsArtifactName: $(abstractionsArtifactName)
      abstractionsPackageVersion: $(abstractionsPackageVersion)
      azureArtifactName: $(azureArtifactName)
      azurePackageVersion: $(azurePackageVersion)
      mdsArtifactName: $(mdsArtifactName)
      mdsPackageVersion: $(mdsPackageVersion)
      testJobTimeout: ${{ parameters.testJobTimeout }}

      # When testing MDS via packages, we must depend on the Abstractions,
      # Azure, and MDS packages.
      ${{ if eq(parameters.referenceType, 'Package') }}:
        dependsOn:
          - build_abstractions_package_stage
          - build_azure_package_stage
          - build_mds_akv_packages_stage

      prebuildSteps: # steps to run prior to building and running tests on each job
        - ${{if ne(parameters.SNIVersion, '')}}:
          - template: /eng/pipelines/common/templates/steps/override-sni-version.yml@self
            parameters:
              SNIVersion: ${{parameters.SNIVersion}}
              SNIValidationFeed: ${{parameters.SNIValidationFeed}}

        - template: /eng/pipelines/common/templates/steps/ci-prebuild-step.yml@self
          parameters:
            debug: ${{ parameters.debug }}
            referenceType: ${{ parameters.referenceType }}

      # Include the code coverage job if the build type is Project.
      ${{ if eq(parameters.referenceType, 'Project') }}:
         # Jobs to run as part of the tests stage, after the tests are done.
        postTestJobs:
        - template: /eng/pipelines/common/templates/jobs/ci-code-coverage-job.yml@self
          parameters:
            debug: ${{ parameters.debug }}
            image: ADO-MMS22-CodeCov
            pool: ${{ parameters.defaultPoolName }}
            targetFrameworks: ${{ parameters.codeCovTargetFrameworks }}
            # This is a Pipeline Variable defined in the Azure DevOps UI.  It
            # must be defined with a true/false value for all pipelines that
            # specify a build type of 'Project'.
            #
            # You can find Pipeline Variables by visiting the main page of the
            # pipeline and choosing Edit -> Variables.
            #
            upload: ${{ eq(variables.ci_var_uploadTestResult, 'true') }}

# test stages configurations
  # self hosted SQL Server on Windows
      testConfigurations:
        windows_sql_19_x64: # configuration name
          pool: ${{parameters.defaultPoolName }} # pool name
          images: # list of images to run tests on
            Win22_Sql19: ADO-MMS22-SQL19 # stage display name: image name from the pool
          TargetFrameworks: ${{parameters.targetFrameworks }} #[net462, net8.0] # list of target frameworks to run
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }} # [1, 2, 3] # list of test sets to run
          useManagedSNI: ${{parameters.useManagedSNI }} # can be used for .NET Core only tests on Windows: [false, true], [false] or [true] values are allowed
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }} # targeted frameworks that is going to participate in test result report generation
          configSqlFor: local # setup Sql Server (local | azure | enclave)
          operatingSystem: Windows # operating system to run tests on (Windows | Linux | Mac)
          configProperties:
            # config.json properties
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: $(SupportsIntegratedSecurity)
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            FileStreamDirectory: $(FileStreamDirectory)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)
            # extra config properties
            SQLRootPath: $(SQL19RootPath)
            enableLocalDB: true
            # instanceName: default: MSSQLSERVER
            # user: default: $(user)
            # saUser: default: $(saUser)
            # fileStreamDirectory: default: ''
            # x64AliasRegistryPath: default: $(x64AliasRegistryPath)
            # x86AliasRegistryPath: default: $(x86AliasRegistryPath)
            # SQLAliasName: default: $(SQLAliasName)
            # SQLAliasPort: default: $(SQLAliasPort)
            # databaseName: default: Northwind
            # localDbAppName: default: $(LocalDbAppName)
            # localDbSharedInstanceName: default: $(LocalDbSharedInstanceName)
            # skipSqlConfiguration: # skips the SQL configuration step


        windows_sql_19_x86: # configuration name
          pool: ${{parameters.defaultPoolName }} # pool name
          images: # list of images to run tests on
            Win22_Sql19_x86: ADO-MMS22-SQL19 # stage display name: image name from the pool
          TargetFrameworks: [net8.0] #[net462, net8.0] # list of target frameworks to run
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }} # [1, 2, 3] # list of test sets to run
          useManagedSNI: [false] # can be used for .NET Core only tests on Windows: [false, true], [false] or [true] values are allowed
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }} # targeted frameworks that is going to participate in test result report generation
          configSqlFor: local # setup Sql Server (local | azure | enclave)
          operatingSystem: Windows # operating system to run tests on (Windows | Linux | Mac)
          configProperties:
            # config.json properties
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: $(SupportsIntegratedSecurity)
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            FileStreamDirectory: $(FileStreamDirectory)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)
            # extra config properties
            x86TestTargetFrameworks: [net8.0] # target frameworks should run tests on x86
            SQLRootPath: $(SQL19RootPath)
            enableLocalDB: true
            # instanceName: default: MSSQLSERVER
            # user: default: $(user)
            # saUser: default: $(saUser)
            # fileStreamDirectory: default: ''
            # x64AliasRegistryPath: default: $(x64AliasRegistryPath)
            # x86AliasRegistryPath: default: $(x86AliasRegistryPath)
            # SQLAliasName: default: $(SQLAliasName)
            # SQLAliasPort: default: $(SQLAliasPort)
            # databaseName: default: Northwind
            # localDbAppName: default: $(LocalDbAppName)
            # localDbSharedInstanceName: default: $(LocalDbSharedInstanceName)
            # skipSqlConfiguration: # skips the SQL configuration step


        windows_sql_22_x64: 
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Sql22: ADO-MMS22-SQL22 
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
          configSqlFor: local
          operatingSystem: Windows
          configProperties:
            # config.json properties
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: $(SupportsIntegratedSecurity)
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            FileStreamDirectory: $(FileStreamDirectory)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)
            # extra config properties
            SQLRootPath: $(SQL22RootPath)
            enableLocalDB: true


        windows_sql_22_x86: 
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Sql22_x86: ADO-MMS22-SQL22 
          TargetFrameworks: [net462]
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: [false]
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
          configSqlFor: local
          operatingSystem: Windows
          configProperties:
            # config.json properties
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: $(SupportsIntegratedSecurity)
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            FileStreamDirectory: $(FileStreamDirectory)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)
            # extra config properties
            x86TestTargetFrameworks: [net462] # target frameworks should run tests on x86 as well
            SQLRootPath: $(SQL22RootPath)
            enableLocalDB: true


        windows_sql_22_named_instance:
          pool: ${{parameters.defaultPoolName }}
          images:
            Win22_Sql22_Named_Instance: ADO-MMS22-SQL22-WITH-NAMED-INSTANCE
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
          configSqlFor: local
          operatingSystem: Windows
          configProperties:
            # config.json properties
            TCPConnectionString: $(SQL_TCP_INSTANCE_CONN_STRING)
            NPConnectionString: $(SQL_NP_INSTANCE_CONN_STRING)
            SupportsIntegratedSecurity: $(SupportsIntegratedSecurity)
            # extra config properties
            SQLRootPath: $(SQL22RootPath)
            instanceName: $(NamedInstance)


    # Azure SQL Server - Windows
        windows_azure_sql:
          pool: ${{parameters.defaultPoolName }} 
          images: 
            Win22_Azure_Sql: ADO-MMS22-SQL19
            Win11_Azure_Sql: ADO-CI-Win11
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
          configSqlFor: azure
          operatingSystem: Windows
          configProperties:
            # config.json properties
            TCPConnectionString: $(AZURE_DB_TCP_CONN_STRING)
            NPConnectionString: $(AZURE_DB_NP_CONN_STRING)
            AADAuthorityURL: $(AADAuthorityURL)
            # Note: Using the isFork variable to determine if secrets are available is not ideal since
            # it's an indirect association. But everything else (referencing secret variables various
            # ways to detect if they were present) won't run consistently across forks and non-forks.
            ${{ if eq(variables['system.pullRequest.isFork'], 'False') }}:
              AADPasswordConnectionString: $(AAD_PASSWORD_CONN_STR)
              AADServicePrincipalSecret: $(AADServicePrincipalSecret)
            AADServicePrincipalId: $(AADServicePrincipalId)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: false
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

        windows_azure_arm64_sql:
          pool: ADO-CI-PUBLIC-ARM64-1ES-EUS-POOL
          images: 
            Win11_ARM64_Azure_Sql: ADO-WIN11-ARM64
          TargetFrameworks: ${{parameters.targetFrameworks }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: ${{parameters.buildPlatforms }}
          testSets: ${{parameters.testSets }}
          useManagedSNI: ${{parameters.useManagedSNI }}
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
          configSqlFor: azure
          operatingSystem: Windows
          configProperties:
            # config.json properties
            TCPConnectionString: $(AZURE_DB_TCP_CONN_STRING_eastus)
            NPConnectionString: $(AZURE_DB_NP_CONN_STRING_eastus)
            AADAuthorityURL: $(AADAuthorityURL)
            ${{ if eq(variables['system.pullRequest.isFork'], 'False') }}:
              AADPasswordConnectionString: $(AAD_PASSWORD_CONN_STR_eastus)
              AADServicePrincipalSecret: $(AADServicePrincipalSecret)
            AADServicePrincipalId: $(AADServicePrincipalId)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: false
            UserManagedIdentityClientId: $(UserManagedIdentityClientId_eastus)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

    # self hosted SQL Server on Linux
        linux_ub20_22_sql_22:
          pool: ${{parameters.defaultPoolName }}
          images:
            Ubuntu20_Sql22: ADO-UB20-SQL22 # drop testing against UB20 image post April 2025
            Ubuntu22_Sql22: ADO-UB22-SQL22
          TargetFrameworks: ${{parameters.targetFrameworksUnix }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: [AnyCPU]
          testSets: ${{parameters.testSets }}
          useManagedSNI: [true]
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
          configSqlFor: local
          operatingSystem: Linux
          configProperties:
            # config.json properties
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: false
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
            AliasName: $(SQLAliasName)

    # Azure Sql Server - Linux
        linux_azure_sql:
          pool: ${{parameters.defaultPoolName }}
          images:
            Ubuntu22_Azure_Sql: ADO-UB22-SQL22
          TargetFrameworks: ${{parameters.targetFrameworksUnix }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: [AnyCPU]
          testSets: ${{parameters.testSets }}
          useManagedSNI: [true]
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
          configSqlFor: azure
          operatingSystem: Linux
          configProperties:
            # config.json properties
            TCPConnectionString: $(AZURE_DB_TCP_CONN_STRING)
            NPConnectionString: $(AZURE_DB_NP_CONN_STRING)
            AADAuthorityURL: $(AADAuthorityURL)
            ${{ if eq(variables['system.pullRequest.isFork'], 'False') }}:
              AADPasswordConnectionString: $(AAD_PASSWORD_CONN_STR)
              AADServicePrincipalSecret: $(AADServicePrincipalSecret)
            AADServicePrincipalId: $(AADServicePrincipalId)
            AzureKeyVaultUrl: $(AzureKeyVaultUrl)
            AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
            SupportsIntegratedSecurity: false
            UserManagedIdentityClientId: $(UserManagedIdentityClientId)
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

        # Self hosted SQL Server on Mac
        mac_sql_22:
          pool: Azure Pipelines
          hostedPool: true
          images:
            MacOSLatest_Sql22: macos-latest
          TargetFrameworks: ${{parameters.targetFrameworksUnix }}
          netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
          buildPlatforms: [AnyCPU]
          testSets: ${{parameters.testSets }}
          useManagedSNI: [true]
          codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
          configSqlFor: local
          operatingSystem: Mac
          configProperties:
            # config.json properties
            TCPConnectionString: $(SQL_TCP_CONN_STRING)
            NPConnectionString: $(SQL_NP_CONN_STRING)
            SupportsIntegratedSecurity: false
            ManagedIdentitySupported: false
            LocalDbAppName: $(LocalDbAppName)
            LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

        # Enclave tests
        #
        # Only run the AE tests if enable and if we have access to the necessary
        # secrets.
        ${{ if and(eq(parameters.runAlwaysEncryptedTests, true), eq(variables['system.pullRequest.isFork'], 'False')) }}:
          windows_enclave_sql:
            pool: ADO-CI-AE-1ES-Pool
            images:
              Win22_Enclave_Sql19: ADO-MMS22-SQL19
            TargetFrameworks: ${{parameters.targetFrameworks }}
            netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
            buildPlatforms: ${{parameters.buildPlatforms }}
            testSets: [AE]
            useManagedSNI: ${{parameters.useManagedSNI }}
            codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
            configSqlFor: enclave
            operatingSystem: Windows
            configProperties:
              # config.json properties
              TCPConnectionStringHGSVBS: $(SQL_TCP_CONN_STRING_HGSVBS)
              TCPConnectionStringNoneVBS: $(SQL_TCP_CONN_STRING_NoneVBS)
              TCPConnectionStringAASSGX: $(SQL_TCP_CONN_STRING_AASSGX)
              EnclaveEnabled: true
              AADAuthorityURL: $(AADAuthorityURL)
              AADServicePrincipalId: $(AADServicePrincipalId)
              ${{ if eq(variables['system.pullRequest.isFork'], 'False') }}:
                AADServicePrincipalSecret: $(AADServicePrincipalSecret)
              AzureKeyVaultUrl: $(AzureKeyVaultUrl)
              AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
              SupportsIntegratedSecurity: $(SupportsIntegratedSecurity)
              UserManagedIdentityClientId: $(UserManagedIdentityClientId)
              AliasName: $(SQLAliasName)
              LocalDbAppName: $(LocalDbAppName)
              LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)

          linux_enclave_sql:
            pool: ADO-CI-AE-1ES-Pool
            images:
              Ubuntu20_Enclave_Sql19: ADO-UB22-Sql22
            TargetFrameworks: ${{parameters.targetFrameworksUnix }}
            netcoreVersionTestUtils: ${{parameters.netcoreVersionTestUtils }}
            buildPlatforms: [AnyCPU]
            testSets: [AE]
            useManagedSNI: [true]
            codeCovTargetFrameworks: ${{parameters.codeCovTargetFrameworks }}
            configSqlFor: enclave
            operatingSystem: Linux
            configProperties:
              # config.json properties
              TCPConnectionStringHGSVBS: $(SQL_TCP_CONN_STRING_HGSVBS)
              TCPConnectionStringNoneVBS: $(SQL_TCP_CONN_STRING_NoneVBS)
              TCPConnectionStringAASSGX: $(SQL_TCP_CONN_STRING_AASSGX)
              EnclaveEnabled: true
              AADServicePrincipalId: $(AADServicePrincipalId)
              ${{ if eq(variables['system.pullRequest.isFork'], 'False') }}:
                AADServicePrincipalSecret: $(AADServicePrincipalSecret)
              AzureKeyVaultUrl: $(AzureKeyVaultUrl)
              AzureKeyVaultTenantId: $(AzureKeyVaultTenantId)
              SupportsIntegratedSecurity: false
              UserManagedIdentityClientId: $(UserManagedIdentityClientId)
              LocalDbAppName: $(LocalDbAppName)
              LocalDbSharedInstanceName: $(LocalDbSharedInstanceName)
