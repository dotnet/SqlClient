################################################################################
# Licensed to the .NET Foundation under one or more agreements.                #
# The .NET Foundation licenses this file to you under the MIT license.         #
# See the LICENSE file in the project root for more information.               #
################################################################################

# This job runs unit tests for the Abstractions project.

parameters:

  # The build configuration to use.
  - name: buildConfiguration
    type: string
    values:
      - Debug
      - Release

  # True to enable debug steps and logging.
  - name: debug
    type: boolean
    default: false

  # The verbosity level for the dotnet CLI commands.
  - name: dotnetVerbosity
    type: string
    default: normal
    values:
    - quiet
    - minimal
    - normal
    - detailed
    - diagnostic

  # The OneBranch templates require that the $(ob_outputDirectory) variable be defined at every job
  # level.  Strangely, it is inherited by jobs defined in the same file that extends the OneBranch
  # template, but not in jobs abstracted behind a stage template like this file.
  - name: onebranchOutputDirectory
    type: string

jobs:
  - job: abstractions_test_job
    displayName: Run Unit Tests

    pool:
      type: linux

    variables:
      # Re-define $(ob_outputDirectory) for the strange OneBranch template expansion checks.
      - name: ob_outputDirectory
        value: ${{ parameters.onebranchOutputDirectory }}

    steps:
      # Install the .NET SDK.
      - template: /eng/pipelines/steps/install-dotnet.yml@self

      # Run the unit tests.
      - task: DotNetCoreCLI@2
        displayName: Run Unit Tests
        inputs:
          command: custom
          custom: test
          projects: $(projectPath)
          arguments: >-
            --configuration ${{ parameters.buildConfiguration }}
            -p:AbstractionsAssemblyFileVersion=$(assemblyFileVersion)
            -p:AbstractionsPackageVersion=$(packageVersion)
            -p:ReferenceType=Package
            --verbosity ${{ parameters.dotnetVerbosity }}
