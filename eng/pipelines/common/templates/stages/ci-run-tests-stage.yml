#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################

# This stage depends on the secrets_stage.

parameters:
  # The name of the Abstractions pipeline artifacts to download.
  - name: abstractionsArtifactsName
    type: string

  # The version of the Abstractions package to depend on when referenceType is 'Package'.
  - name: abstractionsPackageVersion
    type: string

  # Additional stages we depend on, if any.
  - name: additionalDependsOn
    type: object
    default: []

  # The C# build configuration to build (e.g. Debug or Release).
  - name: buildConfiguration
    type: string
    values:
      - Debug
      - Release

  # True to emit debug information and steps.
  - name: debug
    type: boolean
    default: false

  # The name of the Logging pipeline artifacts to download.
  - name: loggingArtifactsName
    type: string
    default: Logging.Artifacts

  # The version of the Logging package to depend on when referenceType is 'Package'.
  - name: loggingPackageVersion
    type: string

  # The name of the SqlClient pipeline artifacts to download.
  - name: mdsArtifactsName
    type: string
    default: MDS.Artifacts

  # The version of the SqlClient package to depend on when referenceType is 'Package'.
  - name: mdsPackageVersion
    type: string

  # Jobs to run after the test jobs complete, if any.
  - name: postTestJobs
    type: jobList
    default: []

  # Steps to run before the build starts, if any.
  - name: prebuildSteps
    type: stepList
    default: []

  # The C# project reference type to use when building and packing the packages.
  - name: referenceType
    type: string
    default: Project
    values:
      # Reference sibling packages as NuGet packages.
      - Package
      # Reference sibling packages as C# projects.
      - Project

  # Each entry in this object will become a test stage.
  - name: testConfigurations
    type: object

  # The timeout, in minutes, for each test job.
  - name: testJobTimeout
    type: number

stages:
- ${{ each config in parameters.testConfigurations }}:
  - ${{ each image in config.value.images }}:
    - stage: ${{ image.key }}
      dependsOn:
        - secrets_stage
        - ${{ each dep in parameters.additionalDependsOn }}:
          - ${{ dep }}

      variables:
        # Bring the SA password from the secrets_stage into scope here.
        - name: saPassword
          value: $[stageDependencies.secrets_stage.secrets_job.outputs['SaPassword.Value']]

      jobs:
      - ${{ each targetFramework in config.value.TargetFrameworks }}:
        - ${{ each platform in config.value.buildPlatforms }}:
          - ${{ each testSet in config.value.TestSets }}:
            - ${{ if contains(targetFramework, 'net4') }}: # .NET Framework
              - template: /eng/pipelines/common/templates/jobs/ci-run-tests-job.yml@self
                parameters:
                  debug: ${{ parameters.debug }}
                  buildConfiguration: ${{ parameters.buildConfiguration }}
                  referenceType: ${{ parameters.referenceType }}
                  timeout: ${{ parameters.testJobTimeout }}
                  poolName: ${{ config.value.pool }}
                  hostedPool: ${{ eq(config.value.hostedPool, true) }}
                  image: ${{ image.value }}
                  jobDisplayName: ${{ format('{0}_{1}_{2}', replace(targetFramework, '.', '_'), platform, testSet) }}
                  configProperties: ${{ config.value.configProperties }}
                  abstractionsArtifactsName: ${{ parameters.abstractionsArtifactsName }}
                  abstractionsPackageVersion: ${{ parameters.abstractionsPackageVersion }}
                  loggingArtifactsName: ${{ parameters.loggingArtifactsName }}
                  loggingPackageVersion: ${{ parameters.loggingPackageVersion }}
                  mdsArtifactsName: ${{ parameters.mdsArtifactsName }}
                  mdsPackageVersion: ${{ parameters.mdsPackageVersion }}
                  prebuildSteps: ${{ parameters.prebuildSteps }}
                  targetFramework: ${{ targetFramework }}
                  netcoreVersionTestUtils: ${{config.value.netcoreVersionTestUtils }}
                  testSet: ${{ testSet }}
                  configSqlFor: ${{ config.value.configSqlFor }}
                  operatingSystem: ${{ config.value.operatingSystem }}
                  isArm64: ${{ eq(config.value.isArm64, 'true') }}
                  saPassword: $(saPassword)
                  ${{if ne(config.value.configProperties, '{}') }}:
                    ${{ each x86TF in config.value.configProperties.x86TestTargetFrameworks }}:
                      ${{ if eq(x86TF, targetFramework) }}:
                        enableX86Test: true
                        enableX64Test: false
            - ${{ else }}: # .NET
              - ${{ each useManagedSNI in config.value.useManagedSNI }}:
                - template: /eng/pipelines/common/templates/jobs/ci-run-tests-job.yml@self
                  parameters:
                    debug: ${{ parameters.debug }}
                    buildConfiguration: ${{ parameters.buildConfiguration }}
                    referenceType: ${{ parameters.referenceType }}
                    timeout: ${{ parameters.testJobTimeout }}
                    poolName: ${{ config.value.pool }}
                    hostedPool: ${{ eq(config.value.hostedPool, true) }}
                    image: ${{ image.value }}
                    ${{if eq(usemanagedSNI, 'true') }}:
                      jobDisplayName: ${{ format('{0}_{1}_{2}_{3}', replace(targetFramework, '.', '_'), platform, 'ManagedSNI', testSet) }}
                    ${{ else }}:
                      jobDisplayName: ${{ format('{0}_{1}_{2}_{3}', replace(targetFramework, '.', '_'), platform, 'NativeSNI', testSet) }}
                    configProperties: ${{ config.value.configProperties }}
                    useManagedSNI: ${{ useManagedSNI }}
                    abstractionsArtifactsName: ${{ parameters.abstractionsArtifactsName }}
                    abstractionsPackageVersion: ${{ parameters.abstractionsPackageVersion }}
                    loggingArtifactsName: ${{ parameters.loggingArtifactsName }}
                    loggingPackageVersion: ${{ parameters.loggingPackageVersion }}
                    mdsArtifactsName: ${{ parameters.mdsArtifactsName }}
                    mdsPackageVersion: ${{ parameters.mdsPackageVersion }}
                    prebuildSteps: ${{ parameters.prebuildSteps }}
                    targetFramework: ${{ targetFramework }}
                    netcoreVersionTestUtils: ${{config.value.netcoreVersionTestUtils }}
                    testSet: ${{ testSet }}
                    configSqlFor: ${{ config.value.configSqlFor }}
                    operatingSystem: ${{ config.value.operatingSystem }}
                    isArm64: ${{ eq(config.value.isArm64, 'true') }}
                    saPassword: $(saPassword)
                    ${{if and(eq(usemanagedSNI, false), ne(config.value.configProperties, '{}')) }}:
                      ${{ each x86TF in config.value.configProperties.x86TestTargetFrameworks }}:
                        ${{ if eq(x86TF, targetFramework) }}:
                          enableX86Test: true
                          enableX64Test: false

- ${{ if ne(length(parameters.postTestJobs), 0) }}:
  - stage: Post_Test
    displayName: 'Post Test Jobs'
    dependsOn:
      - ${{ each config in parameters.testConfigurations }}:
        - ${{ each image in config.value.images }}:
          - ${{ image.key }}
    jobs: ${{ parameters.postTestJobs }}
