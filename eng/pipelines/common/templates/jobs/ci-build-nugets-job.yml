#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:

  - name: referenceType
    type: string
    values:
      - Project
      - Package

  - name: poolName
    type: string
    default: $(ci_var_defaultPoolName)

  - name: imageOverride
    type: string
    default: ADO-MMS22-SQL19

  - name: abstractionsArtifactName
    type: string
    default: Abstractions.Artifact

  - name: mdsArtifactName
    type: string
    default: MDS.Artifact
  
  - name: platform
    type: string
    default: $(Platform)
  
  - name: configuration
    type: string
    default: $(Configuration)

  - name: prebuildSteps
    type: stepList
    default: []

  - name: abstractionsPackageVersion
    type: string

jobs:
- job: build_mds_akv_packages_job
  displayName: Build MDS & AKV Packages

  pool:
    name: ${{parameters.poolName }}
    demands:
    - imageOverride -equals ${{ parameters.imageOverride }}
    - msbuild

  variables:
    - template: ../../../libraries/ci-build-variables.yml@self

  steps:
  - ${{ if ne(parameters.prebuildSteps, '') }}:
    - ${{ parameters.prebuildSteps }} # extra steps to run before the build like downloading sni and the required configuration

  # If we're testing in Package mode, download the Abstractions package
  # artifacts and put them in the packages/ directory in the repo root.
  - ${{ if eq(parameters.referenceType, 'Package') }}:
    - task: DownloadPipelineArtifact@2
      displayName: Download Abstractions Package Artifact
      inputs:
        artifactName: ${{ parameters.abstractionsArtifactName }}
        targetPath: $(Build.SourcesDirectory)/packages

  - template: ../steps/ci-project-build-step.yml@self
    parameters:
      platform: ${{ parameters.platform }}
      configuration: ${{ parameters.configuration }}
      operatingSystem: Windows
      build: all
      abstractionsPackageVersion: ${{parameters.abstractionsPackageVersion}}

  - template: ../steps/generate-nuget-package-step.yml@self
    parameters:
      packageVersion: $(mdsPackageVersion)
      configuration: $(Configuration)
      nuspecPath: 'tools/specs/Microsoft.Data.SqlClient.nuspec'
      outputDirectory: $(packagePath)
      generateSymbolsPackage: false
      displayName: 'Create MDS NuGet Package'

  - template: ../steps/generate-nuget-package-step.yml@self
    parameters:
      packageVersion: $(akvPackageVersion)
      configuration: $(Configuration)
      nuspecPath: 'tools/specs/add-ons/Microsoft.Data.SqlClient.AlwaysEncrypted.AzureKeyVaultProvider.nuspec'
      outputDirectory: $(packagePath)
      generateSymbolsPackage: false
      installNuget: false
      displayName: 'Create AKV NuGet Package'

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Pipeline Artifact'
    inputs:
      targetPath: $(packagePath)
      artifactName: ${{ parameters.mdsArtifactName }}
