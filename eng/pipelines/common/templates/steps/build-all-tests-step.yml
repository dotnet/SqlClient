#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
  - name: abstractionsPackageVersion
    type: string
  
  - name: configuration
    type: string
    default: '$(Configuration)'

  - name: mdsPackageVersion
    type: string

  - name: osGroup
    type: string
    default: ''

  - name: platform
    type: string
    default: $(Platform)

  - name: referenceType
    type: string
    values:
      - Project
      - Package

  - name: targetFramework
    type: string
  
  - name: testSet
    type: string

steps:
- ${{ if contains(parameters.targetFramework, 'net4') }}: # .NET Framework
  - task: MSBuild@1
    displayName: 'Build Tests NetFx'
    inputs:
      solution: build.proj
      platform: '${{parameters.platform }}'
      configuration: '${{parameters.configuration }}'
      msbuildArguments: '-t:BuildTestsNetFx -p:TF=${{parameters.targetFramework }} -p:TestSet=${{parameters.testSet }} -p:ReferenceType=${{parameters.referenceType }} -p:TestMicrosoftDataSqlClientVersion=${{parameters.mdsPackageVersion }} -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}.$(Build.BuildNumber)'

- ${{elseif eq(parameters.osGroup, '')}}: # .NET on Windows
  - task: MSBuild@1
    displayName: 'Build Tests NetCore [Win]'
    inputs:
      solution: build.proj
      platform: '${{parameters.platform }}'
      configuration: '${{parameters.configuration }}'
      msbuildArguments: '-t:BuildTestsNetCore -p:TF=${{parameters.targetFramework }} -p:TestSet=${{parameters.testSet }} -p:ReferenceType=${{parameters.referenceType }} -p:TestMicrosoftDataSqlClientVersion=${{parameters.mdsPackageVersion }} -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}.$(Build.BuildNumber)'
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

- ${{ else }}: # .NET on Unix
  - task: DotNetCoreCLI@2
    displayName: 'Build Tests NetCore [Non-Win]'
    inputs:
      command: custom
      projects: build.proj
      custom: msbuild
      arguments: '-t:BuildTestsNetCore -p:TF=${{parameters.targetFramework }} -p:TestSet=${{parameters.testSet }} -p:ReferenceType=${{parameters.referenceType }} -p:TestMicrosoftDataSqlClientVersion=${{parameters.mdsPackageVersion }} -p:OSGroup=${{parameters.osGroup }} -p:platform=${{parameters.platform }} -p:Configuration=${{parameters.configuration }} -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}.$(Build.BuildNumber)'
      verbosityRestore: Detailed
      verbosityPack: Detailed
    condition: and(succeeded(), ne(variables['Agent.OS'], 'Windows_NT'))
