#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
  - name: debug
    type: boolean
    default: false

  # The path to add as a NuGet source.
  - name: packagePath
    type: string

steps:
- pwsh: |
    # Resolve the path to an absolute path.
    #
    # Resolve-Path throws an error if the path doesn't exist yet, which is an
    # expected scenario here, so we must dance around it.
    $PackagePath = Resolve-Path "${{ parameters.packagePath }}" -ErrorAction SilentlyContinue -ErrorVariable resolveError
    if (-Not ($PackagePath))
    {
      $PackagePath = $resolveError[0].TargetObject
    }

    # Ensure the package path exists, for example if we are going to generate
    # packages in a later step.
    if (-Not (Test-Path -Path "$PackagePath"))
    {
      New-Item -ItemType Directory -Path "$PackagePath" -Force
      Write-Host "Created package path: $PackagePath"
    }

    Write-Host "Adding package path: $PackagePath"

    # Get a list of package sources available
    Get-PackageSource

    # Current location
    Get-Location

    # Register the local nuget folder to be used by nuget.config
    Register-PackageSource  -Name "Pipeline Source" -Location "$PackagePath" -Force -ProviderName NuGet -Trusted

    # Get a list of package sources available after the change
    Get-PackageSource

    # Set the NuGet.config file in the project to use extracted package
    $rootFolder = Get-location
    [Xml] $nugetConfig = Get-Content -Path "NuGet.config"
    $newAdd = $nugetConfig.CreateElement("add")
    $newAdd.SetAttribute("key","pipeline_source")
    $newAdd.SetAttribute("value", "$PackagePath" )
    $nugetConfig.configuration.packageSources.AppendChild($newAdd)
    $nugetConfig.Save("$rootFolder/NuGet.config")
  displayName: 'Add source to NuGet.config'

- ${{ if parameters.debug }}:
  - pwsh: |
      # Display the content of the NuGet.config file
      Get-Content -Path "NuGet.config"
    displayName: '[Debug] Emit NuGet.config'
