#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
  - name: dryRun
    type: boolean
  - name: internalFeedSource
    type: string
  - name: packagesGlob
    type: string
    default: '$(System.DefaultWorkingDirectory)/_dotnet-sqlclient-Official/drop_buildMDS_build_signed_package/*.nupkg'

steps:
- script: |
    set -e
    SRC='${{ parameters.internalFeedSource }}'
    if [ -z "$SRC" ]; then
      echo "Internal feed source parameter not set."
      exit 1
    fi
    if [ "${{ parameters.dryRun }}" = "true" ]; then
      echo "[DRY RUN] Listing packages targeted for push to: ${{ parameters.publicNuGetSource }}"
      echo "Using glob pattern: ${{ parameters.packagesGlob }}"
      # Derive directory and filename pattern from the glob for a precise find (handles nested patterns minimally)
      glob='${{ parameters.packagesGlob }}'
      dir="${glob%/*}"
      name="${glob##*/}"
      echo "Resolved directory: $dir"
      echo "Filename pattern: $name"
      if [ -d "$dir" ]; then
        echo "Matched files:" || true
        # Print all matched files to identify what would be pushed
        find "$dir" -type f -name "$name" -print || true
      else
        echo "Directory does not exist yet: $dir"
      fi
    fi
    for f in $(find "${{ parameters.packagesGlob }}" -name "*.nupkg"); do
      echo "Push $f"
      dotnet nuget push --source "$SRC" --api-key az "$f"
    done
  displayName: 'Publish to Internal Feed'
