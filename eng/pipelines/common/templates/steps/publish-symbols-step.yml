####################################################################################
# Licensed to the .NET Foundation under one or more agreements.                    #
# The .NET Foundation licenses this file to you under the MIT license.             #
# See the LICENSE file in the project root for more information.                   #
#                                                                                  #
# doc: https://www.osgwiki.com/wiki/Symbols_Publishing_Pipeline_to_SymWeb_and_MSDL #
####################################################################################
parameters:
  # Symbol account name in Azure DevOps organization where symbols will be published
  - name: SymAccount
    type: string
    default: "SqlClientDrivers"

  # Boolean value to indicate whether to publish symbols
  - name: publishSymbols
    type: boolean
    default: false

  # Version of the symbols being published
  - name: symbolsVersion
    type: string
    default: "$(NugetPackageVersion)"

  # Symbol server name (without .trafficmanager.net)
  - name: symbolServer
    type: string
    default: "$(SymbolServer)"

  # Token URI for authenticating to the symbol server
  - name: symbolTokenUri
    type: string
    default: "$(SymbolTokenUri)"

  # Artifact name for the symbols being published
  - name: symbolsArtifactName
    type: string

  # Servers to which symbols should be published
  - name: publishToServers
    type: object
    default:
      internal: true
      public: true

  # Type of reference for which symbols are being published
  - name: referenceType
    default: project
    values:
      - project
      - package

  # Product name associated with the symbols
  # Symbols publishing Step is currently only configured for the MDS driver, as they are required to be published to 3 locations:
  #   1. Azure DevOps Org,
  #.  2. MS Internal Symbols server
  #   3. MS Public symbol server
  # For other products: Symbols are uploaded to NuGet.org symbol server via snuget package push during package publishing.
  - name: product
    default: MDS
    values:
      - MDS
      - MSS
      - AKV

  # Azure subscription for publishing symbols to internal and public symbol servers
  - name: azureSubscription
    type: string
    default: "Symbols publishing Workload Identity federation service-ADO.Net"

steps:
  - powershell: 'Write-Host "##vso[task.setvariable variable=ArtifactServices.Symbol.AccountName;]${{parameters.SymAccount}}"'
    displayName: "Update Symbol.AccountName with ${{parameters.SymAccount}}"
    condition: and(succeeded(), eq(parameters.publishSymbols, true))

  - ${{ if and(eq(parameters.publishSymbols, true), eq(parameters.product, 'MDS')) }}:
      - task: PublishSymbols@2
        displayName: "Upload MDS symbols to ${{parameters.SymAccount }} org"
        inputs:
          SymbolsFolder: '$(Build.SourcesDirectory)\artifacts\${{parameters.referenceType }}\bin'
          SearchPattern: |
            Windows_NT/$(Configuration).AnyCPU/**/Microsoft.Data.SqlClient.pdb
            Unix/$(Configuration).AnyCPU/**/Microsoft.Data.SqlClient.pdb
          IndexSources: false
          SymbolServerType: TeamServices
          SymbolsMaximumWaitTime: 60
          SymbolExpirationInDays: 1825 # 5 years
          SymbolsProduct: Microsoft.Data.SqlClient
          SymbolsVersion: ${{parameters.symbolsVersion }}
          SymbolsArtifactName: ${{parameters.symbolsArtifactName }}
          Pat: $(System.AccessToken)
        condition: and(succeeded(), eq(parameters.publishSymbols, true))
      - task: AzureCLI@2
        displayName: "Publish MDS symbols"
        condition: and(succeeded(), eq(parameters.publishSymbols, true))
        inputs:
          azureSubscription: ${{ parameters.azureSubscription }}
          scriptType: ps
          scriptLocation: inlineScript
          inlineScript: |
            $publishToInternalServer = "${{parameters.publishToServers.internal }}".ToLower()
            $publishToPublicServer = "${{parameters.publishToServers.public }}".ToLower()

            echo "Publishing request name: ${{parameters.symbolsArtifactName }}"
            echo "Publish to internal server: $publishToInternalServer"
            echo "Publish to public server: $publishToPublicServer"      

            $symbolServer = "${{parameters.symbolServer }}"
            $tokenUri = "${{parameters.symbolTokenUri }}"
            $projectName = "Microsoft.Data.SqlClient.SNI"

            $symbolPublishingToken = az account get-access-token --resource $tokenUri --query accessToken -o tsv

            echo ">  1.Symbol publishing token acquired."

            echo "Registering the request name ..."
            $requestName = "${{parameters.symbolsArtifactName }}"
            $requestNameRegistrationBody = "{'requestName': '$requestName'}"
            Invoke-RestMethod -Method POST -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json" -Body $requestNameRegistrationBody

            echo ">  2.Registration of request name succeeded."

            echo "Publishing the symbols ..."
            $publishSymbolsBody = "{'publishToInternalServer': $publishToInternalServer, 'publishToPublicServer': $publishToPublicServer}"
            echo "Publishing symbols request body: $publishSymbolsBody"
            Invoke-RestMethod -Method POST -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests/$requestName" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json" -Body $publishSymbolsBody

            echo ">  3.Request to publish symbols succeeded."

            echo ">  4.Checking the status of the request ..."
            Invoke-RestMethod -Method GET -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests/$requestName" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json"

            echo "PublishingStatus"; echo "-----------------"; echo "0 NotRequested"; echo "1 Submitted"; echo "2 Processing"; echo "3 Completed"
            echo "PublishingResult"; echo "-----------------"; echo "0 Pending"; echo "1 Succeeded"; echo "2 Failed"; echo "3 Cancelled"
