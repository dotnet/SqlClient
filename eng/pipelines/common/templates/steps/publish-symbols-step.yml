####################################################################################
# Licensed to the .NET Foundation under one or more agreements.                    #
# The .NET Foundation licenses this file to you under the MIT license.             #
# See the LICENSE file in the project root for more information.                   #
#                                                                                  #
# doc: https://www.osgwiki.com/wiki/Symbols_Publishing_Pipeline_to_SymWeb_and_MSDL #
####################################################################################
parameters:

  # The full name of the package whose symbols are being published.
  - name: packageFullName
    type: string

  # The version of the package whose symbols are being published.
  - name: packageVersion
    type: string

  # Our symbols account name.
  - name: symbolsAccount
    type: string
    default: SqlClientDrivers

  # The symbols server to publish to.
  - name: symbolServer
    type: string
    default: $(SymbolServer)

  # The token URI for the symbol publishing service.
  - name: symbolTokenUri
    type: string
    default: $(SymbolTokenUri)

  # A pair of flags indicating whether to publish to the internal and public symbol servers.  Both
  # default to true.
  - name: publishToServers
    type: object
    default:
      internal: true
      public: true

steps:
- pwsh: 'Write-Host "##vso[task.setvariable variable=ArtifactServices.Symbol.AccountName;]${{parameters.symbolsAccount}}"'
  displayName: 'Set ArtifactServices.Symbol.AccountName to ${{parameters.symbolsAccount}}'

- pwsh: 'Write-Host "##vso[task.setvariable variable=symbolsArtifactName;]${{ parameters.packageFullName }}_symbols_$(System.TeamProject)_$(Build.Repository.Name)_$(Build.SourceBranchName)_${{ parameters.packageVersion }}_$(System.TimelineId)"'
  displayName: 'Set symbolsArtifactName variable'

- task: PublishSymbols@2
  displayName: 'Upload symbols to ${{parameters.symbolsAccount }} org'
  inputs:
    SymbolsFolder: '$(Build.SourcesDirectory)\artifacts\Package\bin'
    SearchPattern: '**/*.pdb'
    IndexSources: false
    SymbolServerType: TeamServices
    SymbolsMaximumWaitTime: 60
    SymbolExpirationInDays: 1825 # 5 years
    SymbolsProduct: ${{ parameters.packageFullName }}
    SymbolsVersion: ${{ parameters.packageVersion }}
    SymbolsArtifactName: $(symbolsArtifactName)
    Pat: $(System.AccessToken)

- task: AzureCLI@2
  displayName: 'Publish symbols'
  inputs:
    azureSubscription: 'Symbols publishing Workload Identity federation service-ADO.Net'
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      $publishToInternalServer = "${{parameters.publishToServers.internal }}".ToLower()
      $publishToPublicServer = "${{parameters.publishToServers.public }}".ToLower()

      echo "Publishing request name: $(symbolsArtifactName)"
      echo "Publish to internal server: $publishToInternalServer"
      echo "Publish to public server: $publishToPublicServer"

      $symbolServer = "${{parameters.symbolServer }}"
      $tokenUri = "${{parameters.symbolTokenUri }}"
      # Registered project name in the symbol publishing pipeline: https://portal.microsofticm.com/imp/v3/incidents/incident/520844254/summary
      $projectName = "Microsoft.Data.SqlClient.SNI"

      # Get the access token for the symbol publishing service
      $symbolPublishingToken = az account get-access-token --resource $tokenUri --query accessToken -o tsv

      echo ">  1.Symbol publishing token acquired."

      echo "Registering the request name ..."
      $requestName = "$(symbolsArtifactName)"
      $requestNameRegistrationBody = "{'requestName': '$requestName'}"
      Invoke-RestMethod -Method POST -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json" -Body $requestNameRegistrationBody

      echo ">  2.Registration of request name succeeded."

      echo "Publishing the symbols ..."
      $publishSymbolsBody = "{'publishToInternalServer': $publishToInternalServer, 'publishToPublicServer': $publishToPublicServer}"
      echo "Publishing symbols request body: $publishSymbolsBody"
      Invoke-RestMethod -Method POST -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests/$requestName" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json" -Body $publishSymbolsBody

      echo ">  3.Request to publish symbols succeeded."

      # The following REST calls are used to check publishing status.
      echo ">  4.Checking the status of the request ..."

      Invoke-RestMethod -Method GET -Uri "https://$symbolServer.trafficmanager.net/projects/$projectName/requests/$requestName" -Headers @{ Authorization = "Bearer $symbolPublishingToken" } -ContentType "application/json"

      echo "Use below tables to interpret the values of xxxServerStatus and xxxServerResult fields from the response."

      echo "PublishingStatus"
      echo "-----------------"
      echo "0	NotRequested; The request has not been requested to publish."
      echo "1	Submitted; The request is submitted to be published"
      echo "2	Processing; The request is still being processed"
      echo "3	Completed; The request has been completed processing. It can be failed or successful. Check PublishingResult to get more details"

      echo "PublishingResult"
      echo "-----------------"
      echo "0	Pending; The request has not completed or has not been requested."
      echo "1	Succeeded; The request has published successfully"
      echo "2	Failed; The request has failed to publish"
      echo "3	Cancelled; The request was cancelled"
