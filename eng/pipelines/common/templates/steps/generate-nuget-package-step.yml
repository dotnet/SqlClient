#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
  # Nuspec Path.
  - name: nuspecPath
    type: string

  # Package Version.
  - name: packageVersion
    type: string

  # Output Directory.
  - name: outputDirectory
    type: string
    default: '$(Build.SourcesDirectory)/packages'

  # Build Configuration.
  - name: buildConfiguration
    type: string
    default: Debug
    values:
      - Debug
      - Release

  # Generate Symbols Package.
  - name: generateSymbolsPackage
    type: boolean

  # Display Name.
  - name: displayName
    type: string

  # Install Nuget.
  - name: installNuget
    type: boolean
    default: true

  # The C# project reference type to use when building and packing the packages.
  - name: referenceType
    type: string
    values:
      # Reference sibling packages as NuGet packages.
      - Package
      # Reference sibling packages as C# projects.
      - Project

  # Semi-colon separated properties to pass to nuget pack via the -properties argument.
  - name: properties
    type: string
    default: ''

steps:
- ${{ if parameters.installNuget }}:
  - task: NuGetToolInstaller@1
    displayName: 'Install Latest Nuget'
    inputs:
      checkLatest: true

- powershell: |
    $Commit=git rev-parse HEAD
    Write-Host "##vso[task.setvariable variable=CommitHead;]$Commit"
  displayName: CommitHead

- task: NuGetCommand@2
  displayName: ${{parameters.displayName }}
  inputs:
    command: custom
    ${{ if parameters.generateSymbolsPackage }}:
      arguments: >-
        pack
        -Symbols
        -SymbolPackageFormat snupkg
        ${{parameters.nuspecPath}}
        -Version ${{parameters.packageVersion}}
        -OutputDirectory ${{parameters.outputDirectory}}
        -properties "COMMITID=$(CommitHead);Configuration=${{parameters.buildConfiguration}};ReferenceType=${{parameters.referenceType}};${{parameters.properties}}"
    ${{else }}:
      arguments: >-
        pack
        ${{parameters.nuspecPath}}
        -Version ${{parameters.packageVersion}}
        -OutputDirectory ${{parameters.outputDirectory}}
        -properties "COMMITID=$(CommitHead);Configuration=${{parameters.buildConfiguration}};ReferenceType=${{parameters.referenceType}};${{parameters.properties}}"
