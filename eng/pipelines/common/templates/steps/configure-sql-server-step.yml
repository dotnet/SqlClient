#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
# Windows only parameters
  - name: instanceName
    type: string
    default: MSSQLSERVER

  # User.
  - name: user
    type: string
    default: $(user)

  # Sa User.
  - name: saUser
    type: string
    default: $(saUser)

  # The SA password to set when configuring SQL Server.  This will also be used for user accounts
  # if necessary.
  - name: saPassword
    type: string

  # SQL Root Path.
  - name: SQLRootPath
    type: string
    default: ''

  # File Stream Directory.
  - name: fileStreamDirectory
    type: string
    default: ''

  # X64Alias Registry Path.
  - name: x64AliasRegistryPath
    type: string
    default: $(x64AliasRegistryPath)

  # X86Alias Registry Path.
  - name: x86AliasRegistryPath
    type: string
    default: $(x86AliasRegistryPath)

  # SQL Alias Name.
  - name: SQLAliasName
    type: string
    default: $(SQLAliasName)

  # SQL Alias Port.
  - name: SQLAliasPort
    type: string
    default: $(SQLAliasPort)

  # Enable Local DB.
  - name: enableLocalDB
    type: boolean
    default: false

  # Local Db App Name.
  - name: localDbAppName
    type: string
    default: $(LocalDbAppName)

  # Local Db Shared Instance Name.
  - name: localDbSharedInstanceName
    type: string
    default: $(LocalDbSharedInstanceName)

# Common parameters
  - name: netcoreVersionTestUtils
    type: string

  # Database Name.
  - name: databaseName
    type: string
    default: Northwind

  # Operating System.
  - name: operatingSystem
    type: string
    values:
      - Linux
      - Mac
      - Windows

steps:
- ${{ if eq(parameters.operatingSystem, 'Windows') }}:
  # windows only steps
  - template: /eng/pipelines/common/templates/steps/configure-sql-server-win-step.yml@self
    parameters:
      instanceName: ${{parameters.instanceName}}
      user: ${{parameters.user}}
      saUser: ${{parameters.saUser}}
      saPassword: ${{parameters.saPassword}}
      SQLRootPath: ${{parameters.SQLRootPath}}
      fileStreamDirectory: ${{parameters.fileStreamDirectory}}
      x64AliasRegistryPath: ${{parameters.x64AliasRegistryPath}}
      x86AliasRegistryPath: ${{parameters.x86AliasRegistryPath}}
      SQLAliasName: ${{parameters.SQLAliasName}}
      SQLAliasPort: ${{parameters.SQLAliasPort}}
      enableLocalDB: ${{parameters.enableLocalDB}}
      localDbAppName: ${{parameters.localDbAppName}}
      localDbSharedInstanceName: ${{parameters.localDbSharedInstanceName}}

- ${{ elseif eq(parameters.operatingSystem, 'Linux') }}:
  # Linux only steps
  - template: /eng/pipelines/common/templates/steps/configure-sql-server-linux-step.yml@self
    parameters:
      saPassword: ${{ parameters.saPassword }}

- ${{ elseif eq(parameters.operatingSystem, 'Mac') }}:
  # macOS only steps
  - template: /eng/pipelines/common/templates/steps/configure-sql-server-macos-step.yml@self
    parameters:
      saPassword: ${{ parameters.saPassword }}

# Common steps
- task: DotNetCoreCLI@2
  displayName: 'Build Ext Utilities'
  inputs:
    command: build
    arguments: '-f ${{parameters.netcoreVersionTestUtils }}'
    workingDirectory: src/Microsoft.Data.SqlClient/tests/tools/Microsoft.Data.SqlClient.ExtUtilities
  retryCountOnTaskFailure: 1

- task: DotNetCoreCLI@2
  displayName: 'Create Test Database ${{parameters.databaseName }}'
  inputs:
    command: run
    arguments: '-f ${{parameters.netcoreVersionTestUtils }} -- "CreateDatabase" ${{parameters.databaseName }} '
    workingDirectory: src/Microsoft.Data.SqlClient/tests/tools/Microsoft.Data.SqlClient.ExtUtilities
