#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:

  - name: abstractionsPackageVersion
    type: string

  - name: loggingPackageVersion
    type: string
    default: ''

  - name: debug
    type: boolean
    default: false

  - name: targetFramework
    type: string

  - name: mdsPackageVersion
    type: string

  - name: platform
    type: string
    default: $(Platform)

  - name: buildConfiguration
    type: string
    values:
      - Debug
      - Release

  - name: referenceType
    default: Package
    values:
      - Project
      - Package

  - name: testSet
    type: string

  - name: msbuildArchitecture
    default: x64
    values:
      - x64
      - x86

  - name: dotnetx86RootPath # full path to the x86 dotnet root folder with trailing slash
    type: string
    default: ''

  - name: operatingSystem
    type: string
    values:
      - Linux
      - Mac
      - Windows
    default: Windows

  - name: retryCountOnManualTests
    type: number
    default: 2

steps:
- ${{ if parameters.debug }}:
  - powershell: 'dotnet sdk check'
    displayName: '[Debug] .NET sdk check'
    condition: succeededOrFailed()

- ${{if eq(parameters.operatingSystem, 'Windows')}}:
  - ${{if eq(parameters.referenceType, 'Project')}}:
    - task: MSBuild@1
      displayName: 'Run Unit Tests ${{parameters.msbuildArchitecture }}'
      condition: succeededOrFailed()
      inputs:
        solution: build.proj
        msbuildArchitecture: ${{parameters.msbuildArchitecture }}
        platform: '${{parameters.platform }}'
        configuration: '${{parameters.buildConfiguration }}'
        ${{ if eq(parameters.msbuildArchitecture, 'x64') }}:
          msbuildArguments: >-
            -t:RunUnitTests
            -p:TF=${{ parameters.targetFramework }}
            -p:ReferenceType=${{ parameters.referenceType }}
        ${{ else }}: # x86
          msbuildArguments: >-
            -t:RunUnitTests
            -p:TF=${{ parameters.targetFramework }}
            -p:ReferenceType=${{ parameters.referenceType }}
            -p:DotnetPath=${{ parameters.dotnetx86RootPath }}

    - task: MSBuild@1
      displayName: 'Run Flaky Unit Tests ${{parameters.msbuildArchitecture }}'
      condition: succeededOrFailed()
      inputs:
        solution: build.proj
        msbuildArchitecture: ${{parameters.msbuildArchitecture }}
        platform: '${{parameters.platform }}'
        configuration: '${{parameters.buildConfiguration }}'
        ${{ if eq(parameters.msbuildArchitecture, 'x64') }}:
          msbuildArguments: >-
            -t:RunUnitTests
            -p:TF=${{ parameters.targetFramework }}
            -p:ReferenceType=${{ parameters.referenceType }}
            -p:Filter="category=flaky"
            -p:CollectCodeCoverage=false
        ${{ else }}: # x86
          msbuildArguments: >-
            -t:RunUnitTests
            -p:TF=${{ parameters.targetFramework }}
            -p:ReferenceType=${{ parameters.referenceType }}
            -p:DotnetPath=${{ parameters.dotnetx86RootPath }}
            -p:Filter="category=flaky"
            -p:CollectCodeCoverage=false
      continueOnError: true

  - task: MSBuild@1
    displayName: 'Run Functional Tests ${{parameters.msbuildArchitecture }}'
    condition: succeededOrFailed()
    inputs:
      solution: build.proj
      msbuildArchitecture: ${{parameters.msbuildArchitecture }}
      platform: '${{parameters.platform }}'
      configuration: '${{parameters.buildConfiguration }}'
      ${{ if eq(parameters.msbuildArchitecture, 'x64') }}:
        msbuildArguments: >-
          -t:RunFunctionalTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
      ${{ else }}: # x86
        msbuildArguments: >-
          -t:RunFunctionalTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
          -p:DotnetPath=${{ parameters.dotnetx86RootPath }}

  - task: MSBuild@1
    condition: succeededOrFailed()
    displayName: 'Run Flaky Functional Tests ${{parameters.msbuildArchitecture }}'
    inputs:
      solution: build.proj
      msbuildArchitecture: ${{parameters.msbuildArchitecture }}
      platform: '${{parameters.platform }}'
      configuration: '${{parameters.buildConfiguration }}'
      ${{ if eq(parameters.msbuildArchitecture, 'x64') }}:
        msbuildArguments: >-
          -t:RunFunctionalTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
          -p:Filter="category=flaky"
          -p:CollectCodeCoverage=false
      ${{ else }}: # x86
        msbuildArguments: >-
          -t:RunFunctionalTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
          -p:DotnetPath=${{ parameters.dotnetx86RootPath }}
          -p:Filter="category=flaky"
          -p:CollectCodeCoverage=false
    continueOnError: true

  - task: MSBuild@1
    condition: succeededOrFailed()
    displayName: 'Run Manual Tests ${{parameters.msbuildArchitecture }}'
    inputs:
      solution: build.proj
      msbuildArchitecture: ${{parameters.msbuildArchitecture }}
      platform: '${{parameters.platform }}'
      configuration: '${{parameters.buildConfiguration }}'
      ${{ if eq(parameters.msbuildArchitecture, 'x64') }}:
        msbuildArguments: >-
          -t:RunManualTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
      ${{ else }}: # x86
        msbuildArguments: >-
          -t:RunManualTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
          -p:DotnetPath=${{ parameters.dotnetx86RootPath }}
    retryCountOnTaskFailure: ${{parameters.retryCountOnManualTests }}

  - task: MSBuild@1
    condition: succeededOrFailed()
    displayName: 'Run Flaky Manual Tests ${{parameters.msbuildArchitecture }}'
    inputs:
      solution: build.proj
      msbuildArchitecture: ${{parameters.msbuildArchitecture }}
      platform: '${{parameters.platform }}'
      configuration: '${{parameters.buildConfiguration }}'
      ${{ if eq(parameters.msbuildArchitecture, 'x64') }}:
        msbuildArguments: >-
          -t:RunManualTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
          -p:Filter="category=flaky"
          -p:CollectCodeCoverage=false
      ${{ else }}: # x86
        msbuildArguments: >-
          -t:RunManualTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
          -p:DotnetPath=${{ parameters.dotnetx86RootPath }}
          -p:Filter="category=flaky"
          -p:CollectCodeCoverage=false
    continueOnError: true

- ${{ else }}: # Linux or macOS
  - ${{if eq(parameters.referenceType, 'Project')}}:
    - task: DotNetCoreCLI@2
      displayName: 'Run Unit Tests'
      condition: succeededOrFailed()
      inputs:
        command: custom
        projects: build.proj
        custom: msbuild
        arguments: >-
          -t:RunUnitTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
          -p:Platform=${{ parameters.platform }}
          -p:Configuration=${{ parameters.buildConfiguration }}
        verbosityRestore: Detailed
        verbosityPack: Detailed

    - task: DotNetCoreCLI@2
      displayName: 'Run Flaky Unit Tests'
      condition: succeededOrFailed()
      inputs:
        command: custom
        projects: build.proj
        custom: msbuild
        arguments: >-
          -t:RunUnitTests
          -p:TF=${{ parameters.targetFramework }}
          -p:TestSet=${{ parameters.testSet }}
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
          -p:Platform=${{ parameters.platform }}
          -p:Configuration=${{ parameters.buildConfiguration }}
          -p:Filter="category=flaky"
          -p:CollectCodeCoverage=false
        verbosityRestore: Detailed
        verbosityPack: Detailed
      continueOnError: true

  - task: DotNetCoreCLI@2
    displayName: 'Run Functional Tests'
    condition: succeededOrFailed()
    inputs:
      command: custom
      projects: build.proj
      custom: msbuild
      arguments: >-
        -t:RunFunctionalTests
        -p:TF=${{ parameters.targetFramework }}
        -p:TestSet=${{ parameters.testSet }}
        -p:ReferenceType=${{ parameters.referenceType }}
        -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
        -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
        -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
        -p:Platform=${{ parameters.platform }}
        -p:Configuration=${{ parameters.buildConfiguration }}
      verbosityRestore: Detailed
      verbosityPack: Detailed

  - task: DotNetCoreCLI@2
    condition: succeededOrFailed()
    displayName: 'Run Flaky Functional Tests'
    inputs:
      command: custom
      projects: build.proj
      custom: msbuild
      arguments: >-
        -t:RunFunctionalTests
        -p:TF=${{ parameters.targetFramework }}
        -p:TestSet=${{ parameters.testSet }}
        -p:ReferenceType=${{ parameters.referenceType }}
        -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
        -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
        -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
        -p:Platform=${{ parameters.platform }}
        -p:Configuration=${{ parameters.buildConfiguration }}
        -p:Filter="category=flaky"
        -p:CollectCodeCoverage=false
      verbosityRestore: Detailed
      verbosityPack: Detailed
    continueOnError: true

  - task: DotNetCoreCLI@2
    displayName: 'Run Manual Tests'
    condition: succeededOrFailed()
    inputs:
      command: custom
      projects: build.proj
      custom: msbuild
      arguments: >-
        -t:RunManualTests
        -p:TF=${{ parameters.targetFramework }}
        -p:TestSet=${{ parameters.testSet }}
        -p:ReferenceType=${{ parameters.referenceType }}
        -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
        -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
        -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
        -p:platform=${{ parameters.platform }}
        -p:Configuration=${{ parameters.buildConfiguration }}
      verbosityRestore: Detailed
      verbosityPack: Detailed
    retryCountOnTaskFailure: ${{parameters.retryCountOnManualTests }}

  - task: DotNetCoreCLI@2
    displayName: 'Run Flaky Manual Tests'
    condition: succeededOrFailed()
    inputs:
      command: custom
      projects: build.proj
      custom: msbuild
      arguments: >-
        -t:RunManualTests
        -p:TF=${{ parameters.targetFramework }}
        -p:TestSet=${{ parameters.testSet }}
        -p:ReferenceType=${{ parameters.referenceType }}
        -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
        -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
        -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
        -p:Platform=${{ parameters.platform }}
        -p:Configuration=${{ parameters.buildConfiguration }}
        -p:Filter="category=flaky"
        -p:CollectCodeCoverage=false
      verbosityRestore: Detailed
      verbosityPack: Detailed
    continueOnError: true
