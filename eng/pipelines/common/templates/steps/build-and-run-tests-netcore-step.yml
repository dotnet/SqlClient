#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
  - name: abstractionsPackageVersion
    type: string
    default: $(abstractionsPackageVersion)

  - name: mdsPackageVersion
    type: string
    default: $(mdsPackageVersion)

  - name: platform
    type: string
    default: $(Platform)

  - name: retryCountOnManualTests
    type: number
    default: 2

  - name: TargetNetCoreVersion
    type: string
    default: $(TargetNetCoreVersion)

  - name: TestTargetOS
    type: string
    default: Windowsnetcoreapp
    values:
      - Windowsnetfx
      - Windowsnetcoreapp
      - Unixnetcoreapp

steps:

# Don't run unit tests using package reference. Unit tests are only run using project reference.

- task: DotNetCoreCLI@2
  displayName: 'Run Functional Tests for ${{parameters.TargetNetCoreVersion }}'
  condition: succeededOrFailed()
  inputs:
    command: test
    projects: 'src\Microsoft.Data.SqlClient\tests\FunctionalTests\Microsoft.Data.SqlClient.FunctionalTests.csproj'
    arguments: >-
      -p:Platform=${{ parameters.platform }}
      -p:TestTargetOS=${{ parameters.TestTargetOS }}
      -p:TargetNetCoreVersion=${{ parameters.TargetNetCoreVersion }}
      -p:ReferenceType=Package
      -p:Configuration=Release
      -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
      -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
      --no-build
      -v n
      --filter "category!=failing&category!=flaky"
      --blame-hang
      --blame-hang-dump-type full
      --blame-hang-timeout 10m

- task: DotNetCoreCLI@2
  displayName: 'Run Flaky Functional Tests for ${{parameters.TargetNetCoreVersion }}'
  condition: succeededOrFailed()
  inputs:
    command: test
    projects: 'src\Microsoft.Data.SqlClient\tests\FunctionalTests\Microsoft.Data.SqlClient.FunctionalTests.csproj'
    arguments: >-
      -p:Platform=${{ parameters.platform }}
      -p:TestTargetOS=${{ parameters.TestTargetOS }}
      -p:TargetNetCoreVersion=${{ parameters.TargetNetCoreVersion }}
      -p:ReferenceType=Package
      -p:Configuration=Release
      -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
      -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
      --no-build
      -v n
      --filter "category=flaky"
      --blame-hang
      --blame-hang-dump-type full
      --blame-hang-timeout 10m
  continueOnError: true

- task: DotNetCoreCLI@2
  displayName: 'Run Manual Tests for ${{parameters.TargetNetCoreVersion }}'
  condition: succeededOrFailed()
  inputs:
    command: test
    projects: 'src\Microsoft.Data.SqlClient\tests\ManualTests\Microsoft.Data.SqlClient.ManualTesting.Tests.csproj'
    arguments: >-
      -p:Platform=${{ parameters.platform }}
      -p:TestTargetOS=${{ parameters.TestTargetOS }}
      -p:TargetNetCoreVersion=${{ parameters.TargetNetCoreVersion }}
      -p:ReferenceType=Package
      -p:Configuration=Release
      -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
      -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
      --no-build
      -v n
      --filter "category!=failing&category!=flaky"
      --collect "Code Coverage"
      --blame-hang
      --blame-hang-dump-type full
      --blame-hang-timeout 10m
  retryCountOnTaskFailure: ${{parameters.retryCountOnManualTests }}

- task: DotNetCoreCLI@2
  displayName: 'Run Flaky Manual Tests for ${{parameters.TargetNetCoreVersion }}'
  condition: succeededOrFailed()
  inputs:
    command: test
    projects: 'src\Microsoft.Data.SqlClient\tests\ManualTests\Microsoft.Data.SqlClient.ManualTesting.Tests.csproj'
    arguments: >-
      -p:Platform=${{ parameters.platform }}
      -p:TestTargetOS=${{ parameters.TestTargetOS }}
      -p:TargetNetCoreVersion=${{ parameters.TargetNetCoreVersion }}
      -p:ReferenceType=Package
      -p:Configuration=Release
      -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
      -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
      --no-build
      -v n
      --filter "category=flaky"
      --collect "Code Coverage"
      --blame-hang
      --blame-hang-dump-type full
      --blame-hang-timeout 10m
  retryCountOnTaskFailure: ${{parameters.retryCountOnManualTests }}
  continueOnError: true
