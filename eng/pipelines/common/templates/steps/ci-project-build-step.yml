#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
  # Platform.
  - name: platform
    type: string
    default: $(Platform)

  # Build Configuration.
  - name: buildConfiguration
    type: string
    values:
      - Debug
      - Release

  # Reference Type.
  - name: referenceType
    type: string
    values:
      - Package
      - Project

  # Build Number.
  - name: buildNumber
    type: string
    default: $(BuildNumber)

  # Operating System.
  - name: operatingSystem
    type: string
    default: deferedToRuntime
    values:
      - Windows
      - Linux
      - MacOS
      - deferedToRuntime

  # Build.
  - name: build
    type: string
    default: MDS
    values:
      - MDS
      - AKV
      - all
      - allNoDocs

  # Necessary to build MDS when referenceType is Package
  - name: abstractionsPackageVersion
    type: string
    default: ''

  # Necessary to build MDS when referenceType is Package
  - name: loggingPackageVersion
    type: string
    default: ''

  # Necessary to build AKV when referenceType is Package.
  - name: mdsPackageVersion
    type: string
    default: ''

  # The assembly build number, kept within 0-65535 range for valid assembly versions.
  - name: assemblyBuildNumber
    type: string
    default: ''

steps:
- ${{ if or(eq(parameters.operatingSystem, 'Windows'), eq(parameters.operatingSystem, 'deferedToRuntime')) }}:
  - ${{ if or(eq(parameters.build, 'MDS'), eq(parameters.build, 'all'), eq(parameters.build, 'allNoDocs')) }}:
    - task: MSBuild@1
      displayName: 'Restore [Win]'
      condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))
      inputs:
        solution: build.proj
        msbuildArchitecture: x64
        msbuildArguments: >-
          -t:restore
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
          -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
      retryCountOnTaskFailure: 1

    - ${{ if eq(parameters.build, 'allNoDocs') }}:
      - task: MSBuild@1
        displayName: 'Build Driver (no docs) [Win]'
        condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))
        inputs:
          solution: build.proj
          msbuildArchitecture: x64
          platform: '${{ parameters.platform }}'
          configuration: '${{ parameters.buildConfiguration }}'
          msbuildArguments: >-
            -t:BuildAllConfigurations
            -p:ReferenceType=${{ parameters.referenceType }}
            -p:GenerateNuget=false
            -p:GenerateDocumentationFile=false
            -p:BuildNumber=${{ parameters.buildNumber }}
            -p:AssemblyBuildNumber=${{ parameters.assemblyBuildNumber }}
            -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
            -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
            -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}

    - ${{ if or(eq(parameters.build, 'MDS'), eq(parameters.build, 'all')) }}:
      - task: MSBuild@1
        displayName: 'Build Driver [Win]'
        condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))
        inputs:
          solution: build.proj
          msbuildArchitecture: x64
          platform: '${{ parameters.platform }}'
          configuration: '${{ parameters.buildConfiguration }}'
          msbuildArguments:
            -t:BuildAllConfigurations
            -p:ReferenceType=${{ parameters.referenceType }}
            -p:GenerateNuget=false
            -p:BuildNumber=${{ parameters.buildNumber }}
            -p:AssemblyBuildNumber=${{ parameters.assemblyBuildNumber }}
            -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
            -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
            -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}

  - ${{ if or(eq(parameters.build, 'AKV'), eq(parameters.build, 'all'), eq(parameters.build, 'allNoDocs')) }}:
    - task: MSBuild@1
      displayName: 'Build AKV Provider NetFx [Win]'
      condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))
      inputs:
        solution: build.proj
        msbuildArchitecture: x64
        platform: '${{ parameters.platform }}'
        configuration: '${{ parameters.buildConfiguration }}'
        msbuildArguments: >-
          -t:BuildAKVNetFx
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:GenerateNuget=false
          -p:BuildNumber=${{ parameters.buildNumber }}
          -p:AssemblyBuildNumber=${{ parameters.assemblyBuildNumber }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}

    - task: MSBuild@1
      displayName: 'Build AKV Provider NetCore All OS [Win]'
      condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))
      inputs:
        solution: build.proj
        msbuildArchitecture: x64
        platform: '${{ parameters.platform }}'
        configuration: '${{ parameters.buildConfiguration }}'
        msbuildArguments: >-
          -t:BuildAKVNetCoreAllOS
          -p:ReferenceType=${{ parameters.referenceType }}
          -p:GenerateNuget=false
          -p:BuildNumber=${{ parameters.buildNumber }}
          -p:AssemblyBuildNumber=${{ parameters.assemblyBuildNumber }}
          -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}

- ${{ if or(eq(parameters.operatingSystem, 'Linux'), eq(parameters.operatingSystem, 'MacOS'), eq(parameters.operatingSystem, 'deferedToRuntime')) }}:
  - task: DotNetCoreCLI@2
    displayName: 'Build Driver [${{ parameters.operatingSystem }}]'
    condition: and(succeeded(), ne(variables['Agent.OS'], 'Windows_NT'))
    inputs:
      command: custom
      projects: build.proj
      custom: msbuild
      arguments: >-
        -t:BuildAll
        -p:ReferenceType=${{ parameters.referenceType }}
        -p:TestEnabled=true
        -p:GenerateNuget=false
        -p:GenerateDocumentationFile=false
        -p:Configuration=${{ parameters.buildConfiguration }}
        -p:BuildNumber=${{ parameters.buildNumber }}
        -p:AssemblyBuildNumber=${{ parameters.assemblyBuildNumber }}
        -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
        -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
        -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
      verbosityRestore: Detailed
      verbosityPack: Detailed
    retryCountOnTaskFailure: 1
