#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################
parameters:
  # Artifact Type.
  - name: artifactType
    values:
    - dll
    - pkg

  # Source Root.
  - name: sourceRoot
    type: string
    default: $(REPO_ROOT)

  # Artifact Directory.
  - name: artifactDirectory
    type: string
    default: $(artifactDirectory)

  # ESRP Connected Service Name.
  - name: ESRPConnectedServiceName
    type: string
    default: $(ESRPConnectedServiceName)

  # App Registration Client Id.
  - name: appRegistrationClientId
    type: string
    default: $(appRegistrationClientId)

  # App Registration Tenant Id.
  - name: appRegistrationTenantId
    type: string
    default: $(appRegistrationTenantId)

  # Auth AKV Name.
  - name: AuthAKVName
    type: string
    default: $(AuthAKVName)

  # Auth Sign Cert Name.
  - name: AuthSignCertName
    type: string
    default: $(AuthSignCertName)

  # Esrp Client Id.
  - name: EsrpClientId
    type: string
    default: $(EsrpClientId)

steps:
- ${{ if eq(parameters.artifactType, 'dll') }}:
  - task: EsrpMalwareScanning@6
    displayName: 'ESRP MalwareScanning'
    inputs:
      ConnectedServiceName: '${{parameters.ESRPConnectedServiceName }}'
      AppRegistrationClientId: '${{parameters.appRegistrationClientId }}'
      AppRegistrationTenantId: '${{parameters.appRegistrationTenantId }}'
      EsrpClientId: '${{parameters.EsrpClientId }}'
      UseMSIAuthentication: true
      FolderPath: '${{parameters.sourceRoot }}'
      Pattern: 'Microsoft.Data.SqlClient*.dll'
      CleanupTempStorage: 1
      VerboseLogin: 1
  - task: EsrpCodeSigning@6
    displayName: 'ESRP CodeSigning'
    inputs:
      ConnectedServiceName: '${{parameters.ESRPConnectedServiceName }}'
      AppRegistrationClientId: '${{parameters.appRegistrationClientId }}'
      AppRegistrationTenantId: '${{parameters.appRegistrationTenantId }}'
      EsrpClientId: '${{parameters.EsrpClientId }}'
      UseMSIAuthentication: true
      AuthAKVName: '${{parameters.AuthAKVName }}'
      AuthSignCertName: '${{parameters.AuthSignCertName }}'
      FolderPath: '${{parameters.sourceRoot }}'
      Pattern: 'Microsoft.Data.SqlClient*.dll'
      signConfigType: inlineSignParams
      inlineOperation: |
          [
              {
                  "keyCode": "CP-230012",
                  "operationSetCode": "SigntoolSign",
                  "parameters": [
                  {
                      "parameterName": "OpusName",
                      "parameterValue": "Microsoft Data SqlClient Data Provider for SQL Server"
                  },
                  {
                      "parameterName": "OpusInfo",
                      "parameterValue": "http://www.microsoft.com"
                  },
                  {
                      "parameterName": "FileDigest",
                      "parameterValue": "/fd \"SHA256\""
                  },
                  {
                      "parameterName": "PageHash",
                      "parameterValue": "/NPH"
                  },
                  {
                      "parameterName": "TimeStamp",
                      "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                  }
                  ],
                  "toolName": "sign",
                  "toolVersion": "1.0"
              },
              {
                  "keyCode": "CP-230012",
                  "operationSetCode": "SigntoolVerify",
                  "parameters": [ ],
                  "toolName": "sign",
                  "toolVersion": "1.0"
              }
          ]

- ${{ if eq(parameters.artifactType, 'pkg') }}:
  - task: EsrpMalwareScanning@6
    displayName: 'ESRP MalwareScanning Nuget Package'
    inputs:
      ConnectedServiceName: '${{parameters.ESRPConnectedServiceName }}'
      AppRegistrationClientId: '${{parameters.appRegistrationClientId }}'
      AppRegistrationTenantId: '${{parameters.appRegistrationTenantId }}'
      EsrpClientId: '${{parameters.EsrpClientId }}'
      UseMSIAuthentication: true
      FolderPath: '${{parameters.artifactDirectory }}'
      Pattern: '*.*nupkg'
      CleanupTempStorage: 1
      VerboseLogin: 1
  - task: EsrpCodeSigning@6
    displayName: 'ESRP CodeSigning Nuget Package'
    inputs:
      inputs:
      ConnectedServiceName: '${{parameters.ESRPConnectedServiceName }}'
      AppRegistrationClientId: '${{parameters.appRegistrationClientId }}'
      AppRegistrationTenantId: '${{parameters.appRegistrationTenantId }}'
      EsrpClientId: '${{parameters.EsrpClientId }}'
      UseMSIAuthentication: true
      AuthAKVName: '${{parameters.AuthAKVName }}'
      AuthSignCertName: '${{parameters.AuthSignCertName }}'
      FolderPath: '${{parameters.artifactDirectory }}'
      Pattern: '*.*nupkg'
      signConfigType: inlineSignParams
      inlineOperation: |
        [
            {
                "keyCode": "CP-401405",
                "operationSetCode": "NuGetSign",
                "parameters": [ ],
                "toolName": "sign",
                "toolVersion": "1.0"
            },
            {
                "keyCode": "CP-401405",
                "operationSetCode": "NuGetVerify",
                "parameters": [ ],
                "toolName": "sign",
                "toolVersion": "1.0"
            }
        ]
