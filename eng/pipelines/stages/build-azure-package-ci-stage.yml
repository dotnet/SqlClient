################################################################################
# Licensed to the .NET Foundation under one or more agreements.  The .NET
# Foundation licenses this file to you under the MIT license.  See the LICENSE
# file in the project root for more information.
################################################################################

# This stage builds the Azure package, runs tests, and publishes the resulting
# NuGet packages as pipeline artifacts.
#
# The NuGet packages have the following properties:
#
#   Name:     Microsoft.Data.SqlClient.Extensions.Azure
#   Version:  azurePackageVersion (from parameters)
#
# The following NuGet packages are published:
#
#   Microsoft.Data.SqlClient.Extensions.Azure.<version>.nupkg
#   Microsoft.Data.SqlClient.Extensions.Azure.<version>.snupkg (symbols)
#
# The packages are published to pipeline artifacts with the name specified by
# the azureArtifactName parameter.
#
# This template defines a stage named 'build_azure_package_stage' that
# can be depended on by downstream stages.

parameters:

  # The name of the Abstractions pipeline artifact to download.
  #
  # This is used when the referenceType is 'Package'.
  - name: abstractionsArtifactName
    type: string
    default: Abstractions.Artifact

  # The Abstractions package verion to depend on.
  #
  # This is used when the referenceType is 'Package'.
  - name: abstractionsPackageVersion
    type: string

  # The name of the pool to use for jobs that require customized VM images.
  - name: adoPoolName
    type: string
    # This variable should be defined in AzureDevOps Library variable groups,
    # for both the Public and ADO.Net projects.
    #
    # Any pool specified here must contain images with the following names:
    #
    #   - ADO-UB22-SQL22
    #   - ADO-CI-Win11
    #
    default: $(ci_var_defaultPoolName)

  # The name of the pipeline artifact to publish.
  - name: azureArtifactName
    type: string
    default: Azure.Artifact

  # The version to apply to the NuGet package and DLLs.
  - name: azurePackageVersion
    type: string

  # The name of the general Azure pool to use for jobs that don't require
  # customized VM images.
  - name: azurePoolName
    type: string
    default: Azure Pipelines

  # The type of build to produce (Release or Debug)
  - name: buildConfiguration
    type: string
    default: Release
    values:
    - Release
    - Debug

  # True to enable extra debug steps and logging.
  - name: debug
    type: boolean
    default: false

  # The stages we depend on, if any.
  - name: dependsOn
    type: object
    default: []

  # The dotnet CLI verbosity to use.
  - name: dotnetVerbosity
    type: string
    default: normal
    values:
    - quiet
    - minimal
    - normal
    - detailed
    - diagnostic

  # The name of the MDS pipeline artifact to download.
  #
  # This is used when the referenceType is 'Package'.
  - name: mdsArtifactName
    type: string
    default: MDS.Artifact

  # The MDS package verion to depend on.
  #
  # This is used when the referenceType is 'Package'.
  - name: mdsPackageVersion
    type: string
  
  # The reference type to use:
  #
  # Project - dependent projects are referenced directly.
  # Package - dependent projects are referenced via NuGet packages.
  #
  - name: referenceType
    type: string
    values:
    - Package
    - Project

stages:

  - stage: build_azure_package_stage
    displayName: Build Azure Package
    
    dependsOn: ${{ parameters.dependsOn }}
    
    jobs:

      # ------------------------------------------------------------------------
      # Build and test on Linux.

      # Use the Azure Pipelines pool for basic testing.
      - template: ../jobs/test-azure-package-ci-job.yml@self
        parameters:
          abstractionsArtifactName: ${{ parameters.abstractionsArtifactName }}
          abstractionsPackageVersion: ${{ parameters.abstractionsPackageVersion }}
          buildConfiguration: ${{ parameters.buildConfiguration }}
          debug: ${{ parameters.debug }}
          displayNamePrefix: Linux
          dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
          jobNameSuffix: linux_basic
          mdsArtifactName: MDS.Artifact
          mdsPackageVersion: ${{ parameters.mdsPackageVersion }}
          netFrameworkRuntimes: []
          netRuntimes: [net8.0, net9.0]
          poolName: ${{ parameters.azurePoolName }}
          referenceType: ${{ parameters.referenceType }}
          vmImage: ubuntu-latest

      # Use our 1ES ADO pool for comprehensive testing.
      - template: ../jobs/test-azure-package-ci-job.yml@self
        parameters:
          abstractionsArtifactName: ${{ parameters.abstractionsArtifactName }}
          abstractionsPackageVersion: ${{ parameters.abstractionsPackageVersion }}
          buildConfiguration: ${{ parameters.buildConfiguration }}
          debug: ${{ parameters.debug }}
          displayNamePrefix: Linux
          dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
          jobNameSuffix: linux_comprehensive
          mdsArtifactName: MDS.Artifact
          mdsPackageVersion: ${{ parameters.mdsPackageVersion }}
          netFrameworkRuntimes: []
          netRuntimes: [net8.0, net9.0]
          poolName: ${{ parameters.adoPoolName }}
          referenceType: ${{ parameters.referenceType }}
          vmImage: ADO-UB22-SQL22

      # ------------------------------------------------------------------------
      # Build and test on Windows

      # Use the Azure Pipelines pool for basic testing.
      - template: ../jobs/test-azure-package-ci-job.yml@self
        parameters:
          abstractionsArtifactName: ${{ parameters.abstractionsArtifactName }}
          abstractionsPackageVersion: ${{ parameters.abstractionsPackageVersion }}
          buildConfiguration: ${{ parameters.buildConfiguration }}
          debug: ${{ parameters.debug }}
          displayNamePrefix: Win
          dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
          jobNameSuffix: windows_basic
          mdsArtifactName: MDS.Artifact
          mdsPackageVersion: ${{ parameters.mdsPackageVersion }}
          netFrameworkRuntimes: [net462]
          netRuntimes: [net8.0, net9.0]
          poolName: ${{ parameters.azurePoolName }}
          referenceType: ${{ parameters.referenceType }}
          vmImage: windows-latest

      # Use our 1ES ADO pool for comprehensive testing.
      - template: ../jobs/test-azure-package-ci-job.yml@self
        parameters:
          abstractionsArtifactName: ${{ parameters.abstractionsArtifactName }}
          abstractionsPackageVersion: ${{ parameters.abstractionsPackageVersion }}
          buildConfiguration: ${{ parameters.buildConfiguration }}
          debug: ${{ parameters.debug }}
          displayNamePrefix: Win
          dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
          jobNameSuffix: windows_comprehensive
          mdsArtifactName: MDS.Artifact
          mdsPackageVersion: ${{ parameters.mdsPackageVersion }}
          netFrameworkRuntimes: [net462]
          netRuntimes: [net8.0, net9.0]
          poolName: ${{ parameters.adoPoolName }}
          referenceType: ${{ parameters.referenceType }}
          vmImage: ADO-CI-Win11

      # ------------------------------------------------------------------------
      # Build and test on macOS.

      # Use the Azure Pipelines pool for basic testing.
      - template: ../jobs/test-azure-package-ci-job.yml
        parameters:
          abstractionsArtifactName: ${{ parameters.abstractionsArtifactName }}
          abstractionsPackageVersion: ${{ parameters.abstractionsPackageVersion }}
          buildConfiguration: ${{ parameters.buildConfiguration }}
          debug: ${{ parameters.debug }}
          displayNamePrefix: macOS
          dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
          jobNameSuffix: macos
          mdsArtifactName: MDS.Artifact
          mdsPackageVersion: ${{ parameters.mdsPackageVersion }}
          netFrameworkRuntimes: []
          netRuntimes: [net8.0, net9.0]
          poolName: ${{ parameters.azurePoolName }}
          referenceType: ${{ parameters.referenceType }}
          vmImage: macos-latest

      # We do not currently have any images in our 1ES ADO pools for macOS.

      # ------------------------------------------------------------------------
      # Create and publish the NuGet package.

      - template: ../jobs/pack-azure-package-ci-job.yml@self
        parameters:
          abstractionsArtifactName: ${{ parameters.abstractionsArtifactName }}
          abstractionsPackageVersion: ${{ parameters.abstractionsPackageVersion }}
          azureArtifactName: ${{ parameters.azureArtifactName }}
          azurePackageVersion: ${{ parameters.abstractionsPackageVersion }}
          buildConfiguration: ${{ parameters.buildConfiguration }}
          debug: ${{ parameters.debug }}
          dependsOn:
            # We depend on all of the test jobs to ensure the tests pass before
            # producing the NuGet package.
            - test_azure_package_job_linux_basic
            - test_azure_package_job_linux_comprehensive
            - test_azure_package_job_windows_basic
            - test_azure_package_job_windows_comprehensive
            - test_azure_package_job_macos
          dotnetVerbosity: ${{ parameters.dotnetVerbosity }}
          referenceType: ${{ parameters.referenceType }}
