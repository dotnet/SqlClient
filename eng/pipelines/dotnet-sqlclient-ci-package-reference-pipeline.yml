#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################

# Use the day of year and a revision number for the build name.  This is what
# appears in the Azure DevOps UI.
name: $(DayOfYear)$(Rev:rr)

# Trigger PR validation runs for all pushes to PRs that target the specified
# branches.
#
# https://learn.microsoft.com/en-us/azure/devops/pipelines/repos/github?view=azure-devops&tabs=yaml#pr-triggers
#
pr:
  branches:
    include:
    # GitHub repo branch targets that will trigger PR validation builds.
    - dev/*
    - feat/*
    - main

  paths:
    include:
    - .azuredevops
    - .config
    - src
    - eng
    - tools
    - azurepipelines-coverage.yml
    - build.proj
    - NuGet.config

# Trigger batched CI runs on pushes to the specified branches.
#
# https://learn.microsoft.com/en-us/azure/devops/pipelines/repos/github?view=azure-devops&tabs=yaml#ci-triggers
#
trigger:
  batch: true
  branches:
    include:
    # GitHub repo branch targets that will trigger CI builds.
    - feat/*
    - main

    # ADO repo branch targets that will trigger CI builds.
    - internal/main

  paths:
    include:
    - .azuredevops
    - .config
    - src
    - eng
    - tools
    - azurepipelines-coverage.yml
    - build.proj
    - NuGet.config

# Schedule periodic CI runs for the main branches.
schedules:

  # ADO internal/main
  - cron: '0 4 * * Fri'
    displayName: Weekly Thursday 9:00 PM (UTC - 7) Build
    branches:
      include:
      - internal/main
    always: true

  # GitHub main
  - cron: '0 0 * * Mon-Fri'
    displayName: Daily build 5:00 PM (UTC - 7) Build
    branches:
      include:
      - main
    always: true

parameters: # parameters are shown up in ADO UI in a build queue time
- name: 'debug'
  displayName: 'Enable debug output'
  type: boolean
  default: false

- name: targetFrameworks
  displayName: 'Target Frameworks on Windows'
  type: object
  default: [net462, net8.0, net9.0]

- name: targetFrameworksLinux
  displayName: 'Target Frameworks on Non-Windows'
  type: object
  default: [net8.0, net9.0]

- name: buildPlatforms
  displayName: 'Build Platforms on Windows'
  type: object
  default: [AnyCPU]

- name: testSets
  displayName: 'Test Sets'
  type: object
  default: [1, 2, 3]

- name: useManagedSNI
  displayName: |
    Use Managed/Native SNI on Windows,
    values [false, true], [false] or [true] are allowed
  type: object
  default: [false, true]

- name: codeCovTargetFrameworks
  displayName: 'Code Coverage Target Frameworks'
  type: object
  default: [net462, net8.0]

- name: buildConfiguration
  displayName: 'Build Configuration'
  default: Release
  values:
    - Release
    - Debug

- name: enableStressTests
  displayName: Enable Stress Tests
  type: boolean
  default: false

# The timeout, in minutes, for each test job.
- name: testsTimeout
  displayName: 'Tests timeout (in minutes)'
  type: string
  default: 90

extends:
  template: dotnet-sqlclient-ci-core.yml@self
  parameters:
    debug: ${{ parameters.debug }}
    targetFrameworks: ${{ parameters.targetFrameworks }}
    targetFrameworksLinux: ${{ parameters.targetFrameworksLinux }}
    buildPlatforms: ${{ parameters.buildPlatforms }}
    testSets: ${{ parameters.testSets }}
    useManagedSNI: ${{ parameters.useManagedSNI }}
    codeCovTargetFrameworks: ${{ parameters.codeCovTargetFrameworks }}
    referenceType: Package
    buildConfiguration: ${{ parameters.buildConfiguration }}
    enableStressTests: ${{ parameters.enableStressTests }}
    testsTimeout: ${{ parameters.testsTimeout }}
