#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################

# NOTE: Because Roslyn analyzers run with the build process, this step must happen within our
#   build in order to generate logs that Guardian/SDL can consume. HOWEVER - this step will rebuild
#   the project and overwrite any previously build output! Therefore, the command line params in
#   this step and the build step must be the same to avoid packaging invalid binaries!
#   There is a way to avoid using this task and have analyzers run during the main build, but this
#   task will ensure we are using the latest analyzers as per SDL.
#   For more info, please see: https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-mohanb/security-integration/guardian-wiki/sdl-azdo-extension/roslyn-analyzers-build-task

parameters:
    - name: buildConfiguration
      type: string

    - name: mdsPackageVersion
      type: string

    - name: signingKeyPath

steps:
    - task: securedevelopmentteam.vss-secure-development-tools.build-task-roslynanalyzers.RoslynAnalyzers@3
      displayName: 'Roslyn Analyzers'
      inputs:
          msBuildArchitecture: x64
          msBuildCommandLine: >-
              msbuild
              $(REPO_ROOT)/build.proj
              -t:BuildAkv
              -p:Configuration=${{ parameters.buildConfiguration }}
              -p:NugetPackageVersion=${{ parameters.mdsPackageVersion }}
              -p:ReferenceType=Package
              -p:SigningKeyPath=${{ parameters.signingKeyPath }}
          msBuildVersion: 17.0
          setupCommandLinePicker: vs2022
