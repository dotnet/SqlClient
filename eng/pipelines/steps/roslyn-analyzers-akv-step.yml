#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################

# This template defines a step to run Roslyn Analyzers on the AKV project build.
# It uses the RoslynAnalyzers@3 task from the Secure Development Team's SDL
# extension:
#
# https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-mohanb/security-integration/guardian-wiki/sdl-azdo-extension/roslyn-analyzers-build-task
#
# GOTCHA: This step will clobber any existing build output.  It should be run
# _before_ any build steps that perform versioning or signing.

# @TODO: This can probably be made generic and pass in the command lines for msbuild
#        BUT, they should be kept separate by now as we rebuild build.proj in parallel, we won't
#        affect >1 project at a time.

parameters:
    # Akv Package Version.
    - name: akvPackageVersion
      type: string

    # Build Configuration.
    - name: buildConfiguration
      type: string
      values:
        - Debug
        - Release

    # Mds Package Version.
    - name: mdsPackageVersion
      type: string

    # Logging Package Version.
    - name: loggingPackageVersion
      type: string

    # Abstractions Package Version.
    - name: abstractionsPackageVersion
      type: string

steps:
    - task: securedevelopmentteam.vss-secure-development-tools.build-task-roslynanalyzers.RoslynAnalyzers@3
      displayName: 'Roslyn Analyzers'
      inputs:
          msBuildArchitecture: x64
          msBuildCommandLine: >-
              msbuild
              $(REPO_ROOT)/build.proj
              -t:BuildAkv
              -p:Configuration=${{ parameters.buildConfiguration }}
              -p:AkvPackageVersion=${{ parameters.akvPackageVersion }}
              -p:MdsPackageVersion=${{ parameters.mdsPackageVersion }}
              -p:LoggingPackageVersion=${{ parameters.loggingPackageVersion }}
              -p:AbstractionsPackageVersion=${{ parameters.abstractionsPackageVersion }}
              -p:ReferenceType=Package
          msBuildVersion: 17.0
          setupCommandLinePicker: vs2022
