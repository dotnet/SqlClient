#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################

# Build step for Microsoft.SqlServer.Server.  Builds the library using the
# BuildSqlServerLibAnyOS target.  The DLLs are output to the standard artifacts
# directory (under $(BUILD_OUTPUT)) and the NuGet package is created separately
# via compound-nuget-pack-step.yml using a nuspec file.

parameters:
    - name: assemblyFileVersion
      type: string

    - name: packageVersion
      type: string

    - name: buildConfiguration
      type: string
      values:
          - Debug
          - Release

steps:
    - task: DownloadSecureFile@1
      displayName: 'Download Signing Key'
      inputs:
          retryCount: 5
          secureFile: 'netfxKeypair.snk'

    - task: MSBuild@1
      displayName: 'Build.proj - BuildSqlServerLibAnyOS'
      inputs:
          solution: '$(REPO_ROOT)/build.proj'
          configuration: '${{ parameters.buildConfiguration }}'
          msbuildArguments: >-
              -t:BuildSqlServerLibAnyOS
              -p:SqlServerAssemblyVersion=${{ parameters.packageVersion }}
              -p:SqlServerAssemblyFileVersion=${{ parameters.assemblyFileVersion }}
              -p:SqlServerPackageVersion=${{ parameters.packageVersion }}
              -p:ReferenceType=Package
              -p:GenerateNuget=false
              -p:SigningKeyPath=$(Agent.TempDirectory)/netfxKeypair.snk

    - script: tree /a /f $(BUILD_OUTPUT)
      displayName: Output Build Output Tree
