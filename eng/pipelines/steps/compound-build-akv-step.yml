#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################

# @TODO: This can probably be made generic and pass in the command lines for msbuild
#        BUT, they should be kept separate by now as we rebuild build.proj in parallel, we won't
#        affect >1 project at a time.
# @TODO: NugetPackageVersion should not be used for MDS package version

parameters:
  - name: assemblyFileVersion
    type: string

  - name: buildConfiguration
    type: string
    values:
      - Debug
      - Release

  - name: mdsPackageVersion
    type: string

steps:
  - task: DownloadSecureFile@1
    displayName: 'Download Signing Key'
    name: signingKey
    inputs:
        retryCount: 5
        secureFile: 'netfxKeypair.snk'

  # Install the .NET SDK.
  - template: /eng/pipelines/steps/install-dotnet.yml@self

  - task: MSBuild@1
    displayName: 'Build.proj - BuildAkv'
    inputs:
        solution: '$(REPO_ROOT)/build.proj'
        configuration: '${{ parameters.buildConfiguration }}'
        msbuildArguments: >-
            -t:BuildAkv
            -p:AssemblyFileVersion=${{ parameters.assemblyFileVersion }}
            -p:NugetPackageVersion=${{ parameters.mdsPackageVersion }}
            -p:ReferenceType=Package
            -p:SigningKeyPath=$(signingKey.secureFilePath)

  - script: tree /a /f $(BUILD_OUTPUT)
    displayName: Output Build Output Tree
