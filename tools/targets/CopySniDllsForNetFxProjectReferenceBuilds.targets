<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--
    This is a hack to ensure that the SNI native DLLs are included with our
    artifacts for .NET Framework.  Interestingly, they seem to be included
    automatically for .NET.

    You can see the magic that performs this copying for package reference
    builds in the SNI repo's target files:

    https://sqlclientdrivers.visualstudio.com/ADO.Net/_git/Microsoft.Data.SqlClient.sni?path=/tools/targets/Microsoft.Data.SqlClient.SNI.targets

    Which is included in the SNI NuGet package for .NET Framework:

    https://sqlclientdrivers.visualstudio.com/ADO.Net/_git/Microsoft.Data.SqlClient.sni?path=/tools/specs/Microsoft.Data.SqlClient.SNI.nuspec

    This somehow instructs downstream builds (i.e. MDS) to inject the above
    targets into the build process and execute them appropriately.  This is why
    package reference builds work fine without any additional help, but project
    reference builds need this extra copying step.

    Note that we cannot use the <Content> item to perform this copying because
    the SNI DLL files don't exist at the time that MSBuild is evaluating the
    project file.  They only exist once the MDS build has completed.  This would
    result in the <Content Include="..."> attribute not matching any files and
    thus nothing being copied, but only the first time a workspace is built!
    Therefore, we use a Target that runs after the files have been copied to the
    output directory.

    This target relies on properties defined by the top-level Directory.Build.props
    file, so ensure that this targets file is imported after that props file.
  -->
  <Target
    Name="CopySniDllsForNetFx"
    AfterTargets="CopyFilesToOutputDirectory"
    Condition="'$(ReferenceType)' == 'Project' AND '$(TargetFramework)' == 'net462'">

    <!-- Glob for the SNI DLL files. -->
    <ItemGroup>
      <SniDlls Include="$(BinFolder)$(Configuration).AnyCPU/Microsoft.Data.SqlClient$(MdsNetFxSuffix)/netfx/net462/*SNI*.dll" />
    </ItemGroup>

    <!-- Copy the SNI DLLs to the output directory. -->
    <Copy SourceFiles="@(SniDlls)" DestinationFolder="$(OutputPath)" />
  </Target>
</Project>
