<?xml version="1.0" encoding="utf-8"?>
<!--
  This target extracts PDB files from the MDS symbols package and places them
  alongside the restored MDS NuGet package DLLs. This enables code coverage
  collection when running tests against package references.

  This is intended to be used only when running the ManualTests suite in Package
  reference mode with code coverage enabled.

  NOTE: The ManualTests never reference the AKV provider as a package,
  regardless of reference type, so we do not need to extract symbols for that
  assembly.

  Usage: msbuild build.proj -t:ExtractMdsSymbolsForCodeCoverage -p:ReferenceType=Package
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="ExtractMdsSymbolsForCodeCoverage"
          Condition="'$(ReferenceType)' == 'Package' AND '$(CollectCodeCoverage)' == 'true'">

    <PropertyGroup>
      <!-- Default NuGet global packages folder -->
      <NuGetPackagesFolder Condition="'$(NuGetPackagesFolder)' == '' AND '$(OS)' == 'Windows_NT'">$(USERPROFILE)\.nuget\packages</NuGetPackagesFolder>
      <NuGetPackagesFolder Condition="'$(NuGetPackagesFolder)' == '' AND '$(OS)' == 'Unix'">$(HOME)/.nuget/packages</NuGetPackagesFolder>

      <!-- Package info -->
      <SqlClientPackageName>microsoft.data.sqlclient</SqlClientPackageName>
      <SqlClientPackageVersion>$(TestMicrosoftDataSqlClientVersion)</SqlClientPackageVersion>
      <SqlClientPackagePath>$(NuGetPackagesFolder)/$(SqlClientPackageName)/$(SqlClientPackageVersion)</SqlClientPackagePath>

      <!-- Symbol package location -->
      <SnupkgPath>$(PackagesDir)Microsoft.Data.SqlClient.$(SqlClientPackageVersion).snupkg</SnupkgPath>
    </PropertyGroup>

    <Message Text="Extracting MDS symbols from $(SnupkgPath) to $(SqlClientPackagePath)" Importance="high" />

    <!-- Check if snupkg exists -->
    <Error Condition="!Exists('$(SnupkgPath)')"
           Text="MDS symbol package not found: $(SnupkgPath). Build the package first with 'msbuild build.proj -t:GenerateNugetPackage'" />

    <!-- Extract PDBs from snupkg (snupkg is a zip file) -->
    <Exec Command="pwsh -NonInteractive -Command &quot;Expand-Archive -Path '$(SnupkgPath)' -DestinationPath '$(SqlClientPackagePath)' -Force&quot;"
          IgnoreExitCode="false" />

    <Message Text="Successfully extracted MDS symbols for code coverage" Importance="high" />
  </Target>

</Project>
