<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Inline task that generates a static class whose properties expose package versions. -->
  <UsingTask TaskName="GeneratePackageVersionsClass"
             TaskFactory="RoslynCodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <Packages ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <Versions ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <Defaults ParameterType="Microsoft.Build.Framework.ITaskItem[]" />
      <Namespace ParameterType="System.String" Required="true" />
      <OutputFile ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs">
<![CDATA[
// Build a lookup from PackageVersion items (used by Central Package Management).
var versionMap = new System.Collections.Generic.Dictionary<string, string>(
    System.StringComparer.OrdinalIgnoreCase);
foreach (var v in Versions)
    versionMap[v.ItemSpec] = v.GetMetadata("Version");

var sb = new System.Text.StringBuilder();
sb.AppendLine("// <auto-generated/>");
sb.AppendLine();
sb.AppendLine($"namespace {Namespace};");
sb.AppendLine();
sb.AppendLine("internal static class PackageVersions");
sb.AppendLine("{");
// Track which packages we've already emitted.
var emitted = new System.Collections.Generic.HashSet<string>(
    System.StringComparer.OrdinalIgnoreCase);

foreach (var pkg in Packages)
{
    var id = pkg.ItemSpec;

    // Prefer Version metadata on the PackageReference itself; fall back to the
    // PackageVersion item (CPM) if not present.
    var version = pkg.GetMetadata("Version");
    if (string.IsNullOrEmpty(version))
        versionMap.TryGetValue(id, out version);
    if (string.IsNullOrEmpty(version))
        continue;

    var propertyName = id.Replace(".", "");
    sb.AppendLine($"    public static string {propertyName} => \"{version}\";");
    emitted.Add(id);
}

// Emit entries for any default packages that weren't already referenced.
if (Defaults != null)
{
    foreach (var def in Defaults)
    {
        var id = def.ItemSpec;
        if (emitted.Contains(id))
            continue;
        var fallback = def.GetMetadata("DefaultVersion");
        if (string.IsNullOrEmpty(fallback))
            fallback = "None";
        var propertyName = id.Replace(".", "");
        sb.AppendLine($"    public static string {propertyName} => \"{fallback}\";");
    }
}
sb.AppendLine("}");

var dir = System.IO.Path.GetDirectoryName(OutputFile);
if (!string.IsNullOrEmpty(dir) && !System.IO.Directory.Exists(dir))
    System.IO.Directory.CreateDirectory(dir);
System.IO.File.WriteAllText(OutputFile, sb.ToString());
]]>
      </Code>
    </Task>
  </UsingTask>

  <!--
    Generate PackageVersions.g.cs before compilation.  The target passes both
    PackageReference and PackageVersion items so it works with Central Package
    Management (where Version metadata lives on PackageVersion, not PackageReference).
  -->
  <Target Name="GeneratePackageVersionsFile"
          BeforeTargets="CoreCompile"
          DependsOnTargets="CollectPackageReferences"
          Inputs="$(MSBuildProjectFullPath);$(MSBuildAllProjects)"
          Outputs="$(IntermediateOutputPath)PackageVersions.g.cs">
    <PropertyGroup>
      <_PackageVersionsFile>$(IntermediateOutputPath)PackageVersions.g.cs</_PackageVersionsFile>
    </PropertyGroup>

    <!-- Delete the previously generated file so changes are always picked up. -->
    <Delete Files="$(_PackageVersionsFile)" Condition="Exists('$(_PackageVersionsFile)')" />

    <ItemGroup>
      <_DefaultPackageVersionEntry Include="Microsoft.Data.SqlClient.Extensions.Azure" DefaultVersion="None" />
    </ItemGroup>

    <GeneratePackageVersionsClass
      Packages="@(PackageReference)"
      Versions="@(PackageVersion)"
      Defaults="@(_DefaultPackageVersionEntry)"
      Namespace="$(RootNamespace)"
      OutputFile="$(_PackageVersionsFile)" />

    <ItemGroup>
      <Compile Include="$(_PackageVersionsFile)" />
      <FileWrites Include="$(_PackageVersionsFile)" />
    </ItemGroup>
  </Target>

</Project>
