<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <AssemblyName>Microsoft.Data.SqlClient</AssemblyName>
    <TargetFrameworks>net462;net8.0;net9.0;netstandard2.0</TargetFrameworks>
  </PropertyGroup>

  <!-- Platform Not Supported (PNSE) generation ======================= -->
  <PropertyGroup Condition="'$(GeneratePlatformNotSupportedAssembly)' == 'true'">
    <GeneratePlatformNotSupportedAssemblyMessage>Microsoft.Data.SqlClient is not supported on this platform.</GeneratePlatformNotSupportedAssemblyMessage>
    <ContractAssemblyPath>$(TargetDir)$(AssemblyName).dll</ContractAssemblyPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(GeneratePlatformNotSupportedAssembly)' == 'true' OR '$(GeneratePlatformNotSupportedAssemblyMessage)' != ''">
    <NotSupportedSourceFile>$(IntermediateOutputPath)\$(TargetFramework)\$(AssemblyName).notsupported.cs</NotSupportedSourceFile>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);GenerateNotSupportedSource</CoreCompileDependsOn>
    <!-- Not supported sources are created from the ref assembly, we currently don't produce finalizers in dummmy assemblies, so we disable ApiCompat to not fail. -->
    <RunApiCompat>false</RunApiCompat>
    <GenerateDocumentationFile Condition="'$(TargetOs)' != 'Windows_NT'">false</GenerateDocumentationFile>
    <NoWarn>$(NoWarn);CS0618</NoWarn>
  </PropertyGroup>
  <ItemGroup Condition="'$(GeneratePlatformNotSupportedAssembly)' == 'true'">
    <ResolvedMatchingContract Include="$(ContractAssemblyPath)" />
  </ItemGroup>
  <ItemGroup Condition="'$(GeneratePlatformNotSupportedAssembly)' == 'true' OR '$(GeneratePlatformNotSupportedAssemblyMessage)' != ''">
    <AssemblyMetadata Include="NotSupported">
      <Value>True</Value>
    </AssemblyMetadata>
  </ItemGroup>

  <!-- CLS Compliance ================================================== -->
  <ItemGroup>
    <AssemblyAttribute Include="System.CLSCompliantAttribute">
      <_Parameter1>true</_Parameter1>
    </AssemblyAttribute>
  </ItemGroup>

  <!-- Strong name signing ============================================= -->
  <!-- When a signing key is specified, we will perform strong name assembly signing. -->
  <PropertyGroup Condition="'$(SigningKeyPath)' != ''">
    <SignAssembly>true</SignAssembly>
    <AssemblyOriginatorKeyFile>$(SigningKeyPath)</AssemblyOriginatorKeyFile>
  </PropertyGroup>

  <!-- Build Output ==================================================== -->
  <PropertyGroup>
    <!-- @TODO: Move to directory.build.props? -->
    <ArtifactPath>$(RepoRoot)artifacts/</ArtifactPath>

    <!--
      MSBuild will add the target framework to the end of this path by default. Telling it not to
      is possible but also requires specifying the IntermediateOutputPath. So while it would be
      nice to have a flatter directory structure, it's more hassle than its worth.
    -->
    <OutputPath>$(ArtifactPath)$(AssemblyName).ref/$(Configuration)/</OutputPath>
  </PropertyGroup>

  <!-- References ====================================================== -->
  <!-- Reference to Abstractions -->
  <ItemGroup>
    <ProjectReference Include="$(RepoRoot)src/Microsoft.Data.SqlClient.Extensions/Abstractions/src/Abstractions.csproj"
                      Condition="'$(ReferenceType)' != 'Package'" />
    <PackageReference Include="Microsoft.Data.SqlClient.Extensions.Abstractions"
                      Condition="'$(ReferenceType)' == 'Package'" />
  </ItemGroup>

  <!-- References for netframework -->
  <ItemGroup Condition="'$(TargetFramework)' == 'net462'">
    <Reference Include="System" />
    <Reference Include="System.Configuration" />
    <Reference Include="System.Data" />
    <Reference Include="System.EnterpriseServices" />
    <Reference Include="System.Runtime.Caching" />
    <Reference Include="System.Runtime.Serialization" />
    <Reference Include="System.Security" />
    <Reference Include="System.Transactions" />
    <Reference Include="System.Xml" />

    <PackageReference Include="Microsoft.Bcl.Cryptography" />
    <PackageReference Include="Microsoft.Data.SqlClient.SNI"
                      PrivateAssets="all"
                      IncludeAssets="runtime;build;native;contentfiles;analyzers;buildtransitive" />
    <PackageReference Include="Microsoft.Extensions.Caching.Memory" />
    <PackageReference Include="Microsoft.IdentityModel.JsonWebTokens" />
    <PackageReference Include="Microsoft.IdentityModel.Protocols.OpenIdConnect" />
    <PackageReference Include="System.Buffers" />
    <PackageReference Include="System.Diagnostics.DiagnosticSource" />
    <PackageReference Include="System.Runtime.InteropServices.RuntimeInformation" />
    <PackageReference Include="System.Security.Cryptography.Pkcs" />
    <PackageReference Include="System.Text.Json" />
    <PackageReference Include="System.Threading.Channels" />
  </ItemGroup>

  <!-- References for netcore -->
  <ItemGroup Condition="'$(TargetFramework)' != 'net462' AND '$(TargetFramework)' != 'netstandard2.0'">
    <PackageReference Include="Microsoft.Bcl.Cryptography" />
    <PackageReference Include="Microsoft.Data.SqlClient.SNI.runtime" />
    <PackageReference Include="Microsoft.Extensions.Caching.Memory" />
    <PackageReference Include="Microsoft.IdentityModel.JsonWebTokens" />
    <PackageReference Include="Microsoft.IdentityModel.Protocols.OpenIdConnect" />
    <PackageReference Include="Microsoft.SqlServer.Server" />
    <PackageReference Include="System.Configuration.ConfigurationManager" />
    <PackageReference Include="System.Security.Cryptography.Pkcs" />
  </ItemGroup>

  <!-- References for netstandard -->
  <ItemGroup Condition="'$(TargetFramework)' == 'netstandard2.0'">
    <PackageReference Include="Microsoft.Bcl.Cryptography" />
    <PackageReference Include="Microsoft.Data.SqlClient.SNI.runtime" />
    <PackageReference Include="Microsoft.Extensions.Caching.Memory" />
    <PackageReference Include="Microsoft.IdentityModel.JsonWebTokens" />
    <PackageReference Include="Microsoft.IdentityModel.Protocols.OpenIdConnect" />
    <PackageReference Include="Microsoft.SqlServer.Server" />
    <PackageReference Include="System.Configuration.ConfigurationManager" />
    <PackageReference Include="System.Security.Cryptography.Pkcs" />
    <PackageReference Include="System.Text.Json" />
    <PackageReference Include="System.Threading.Channels" />
  </ItemGroup>

  <!-- GenerateNotSupportedSource ===================================== -->
  <Target Name="GenerateNotSupportedSource"
          AfterTargets="ResolveCodeAnalysisRuleSet"
          DependsOnTargets="ResolveMatchingContract"
          Inputs="@(ReferencePath);@(ResolvedMatchingContract)"
          Outputs="$(NotSupportedSourceFile)"
          Condition="'$(GeneratePlatformNotSupportedAssembly)' == 'true' OR '$(GeneratePlatformNotSupportedAssemblyMessage)' != ''">
    <ItemGroup>
      <!-- build out a list of directories where dependencies are located -->
      <_referencePathDirectoriesWithDuplicates Include="@(ReferencePath->'%(RootDir)%(Directory)'->TrimEnd('\'))" />
      <!-- strip metadata, removing duplicates -->
      <_referencePathDirectories Include="%(_referencePathDirectoriesWithDuplicates.Identity)" />
    </ItemGroup>

    <Error Text="No single matching contract found." Condition="'@(ResolvedMatchingContract->Count())' != '1'" />

    <PropertyGroup>
      <GenAPIArgs>"%(ResolvedMatchingContract.Identity)"</GenAPIArgs>
      <GenAPIArgs>$(GenAPIArgs) -l:"@(_referencePathDirectories)"</GenAPIArgs>
      <GenAPIArgs>$(GenAPIArgs) -o:"$(NotSupportedSourceFile)"</GenAPIArgs>
      <GenAPIArgs Condition="'$(GeneratePlatformNotSupportedAssembly)' == 'true' OR '$(GeneratePlatformNotSupportedAssemblyMessage)' != ''">$(GenAPIArgs) -t:"$(GeneratePlatformNotSupportedAssemblyMessage)"</GenAPIArgs>
      <GenAPIArgs Condition="'$(GeneratePlatformNotSupportedAssemblyWithGlobalPrefix)' == 'true'">$(GenAPIArgs) -global</GenAPIArgs>
      <GenAPIPath Condition="'$(MSBuildRuntimeType)' == 'core'"> "$(DotnetPath)dotnet" "$(ToolsArtifactsDir)net8.0/Microsoft.DotNet.GenAPI.dll"</GenAPIPath>
      <GenAPIPath Condition="'$(MSBuildRuntimeType)' != 'core'"> "$(ToolsArtifactsDir)net472\Microsoft.DotNet.GenAPI.exe"</GenAPIPath>
    </PropertyGroup>
    <Exec Command="$(GenAPIPath) $(GenAPIArgs)" WorkingDirectory="$(ToolRuntimePath)"/>
    <ItemGroup>
      <FileWrites Include="$(NotSupportedSourceFile)" />
      <Compile Include="$(NotSupportedSourceFile)" />
    </ItemGroup>
  </Target>
</Project>
